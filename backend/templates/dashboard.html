<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watchlist 2025</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind CSS (via CDN for simplicity, verify with user if local is needed) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @keyframes swingIn {
            0% {
                opacity: 0;
                transform: rotate(-10deg) scale(0.9);
            }

            100% {
                opacity: 1;
                transform: rotate(0) scale(1);
            }
        }

        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-swing {
            animation: swingIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .animate-up {
            opacity: 0;
            animation: fadeInUp 0.7s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .delay-100 {
            animation-delay: 100ms;
        }

        .delay-200 {
            animation-delay: 200ms;
        }

        .delay-300 {
            animation-delay: 300ms;
        }

        .delay-400 {
            animation-delay: 400ms;
        }

        .delay-500 {
            animation-delay: 500ms;
        }

        .delay-600 {
            animation-delay: 600ms;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-dark {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }



        @keyframes fadeInScale {
            0% {
                opacity: 0;
                transform: scale(0.9);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-swing {
            animation: swingIn 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .animate-pop {
            animation: fadeInScale 0.5s ease-out forwards;
        }

        .delay-100 {
            animation-delay: 100ms;
        }

        .delay-200 {
            animation-delay: 200ms;
        }

        .delay-300 {
            animation-delay: 300ms;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .card-hover:hover {
            transform: translateY(-2px);
            transition: all 0.2s ease;
            border-color: rgba(99, 102, 241, 0.5);
        }

        .gradient-text {
            background: linear-gradient(135deg, #818cf8 0%, #c084fc 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
    </style>
    <style>
        /* ... existing styles ... */
        @keyframes swingIn {
            0% {
                opacity: 0;
                transform: rotate(-10deg) scale(0.9);
            }

            100% {
                opacity: 1;
                transform: rotate(0) scale(1);
            }
        }

        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes progress {
            from {
                width: 0%;
            }

            to {
                width: 100%;
            }
        }

        .story-progress-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
            flex: 1;
        }

        .story-progress-fill {
            height: 100%;
            background: white;
            width: 0%;
        }

        .story-active .story-progress-fill {
            animation: progress linear forwards;
        }

        .paused .story-progress-fill {
            animation-play-state: paused;
        }
    </style>
</head>

<body class="min-h-screen pb-12">

    <!-- Navbar -->
    <nav class="glass sticky top-0 z-50 border-b border-slate-700/50">
        <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-indigo-500 flex items-center justify-center text-white font-bold">W
                </div>
                <span class="text-xl font-bold tracking-tight">Watched</span>
            </div>
            <div class="flex gap-4 items-center">
                <!-- Notifications -->
                <div class="relative group">
                    <button id="notif-btn" class="p-2 text-slate-400 hover:text-white relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path>
                            <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path>
                        </svg>
                        <span id="notif-badge"
                            class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full hidden"></span>
                    </button>
                    <div class="absolute right-0 top-full -mt-2 pt-4 w-64 hidden group-hover:block z-50"
                        id="notif-dropdown-wrapper">
                        <div class="bg-slate-900 border border-slate-700 rounded-xl shadow-xl p-2" id="notif-dropdown">
                            <div
                                class="text-xs font-bold text-slate-500 px-2 py-1 uppercase tracking-wider flex justify-between">
                                <span>Notifications</span>
                                <button onclick="clearNotifications()"
                                    class="text-indigo-400 hover:text-white">Clear</button>
                            </div>
                            <div id="notif-list" class="max-h-60 overflow-y-auto space-y-1 mt-1">
                                <div class="text-center text-slate-600 text-xs py-4">No new updates</div>
                            </div>
                        </div>
                    </div>
                </div>
                <button onclick="switchTab('watchlist')"
                    class="px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-800 transition-colors text-white flex items-center"
                    id="tab-watchlist"><i data-lucide="play-circle" class="w-4 h-4 mr-2"></i> Watchlist</button>
                <button onclick="switchTab('history')"
                    class="px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-800 transition-colors text-slate-400 flex items-center"
                    id="tab-history"><i data-lucide="clock" class="w-4 h-4 mr-2"></i> History</button>
                <button onclick="switchTab('analytics')"
                    class="px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-800 transition-colors text-slate-400 flex items-center"
                    id="tab-analytics"><i data-lucide="bar-chart-2" class="w-4 h-4 mr-2"></i> Analytics</button>
                <button onclick="switchView('social')"
                    class="px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-800 transition-colors text-slate-400 flex items-center"
                    id="tab-social"><i data-lucide="users" class="w-4 h-4 mr-2"></i> Friends</button>
                <button
                    class="px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-800 transition-colors text-slate-400 flex items-center relative"
                    onclick="openInbox()" id="tab-inbox">
                    <i data-lucide="inbox" class="w-4 h-4 mr-2"></i> Inbox
                    <span id="inbox-badge"
                        class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center">0</span>
                </button>
                <!-- Rankings (hidden during Wrapped season: Nov 29 - Dec 31) -->
                <button onclick="switchView('leaderboard')"
                    class="px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-800 transition-colors text-slate-400 flex items-center"
                    id="tab-leaderboard"><i data-lucide="trophy" class="w-4 h-4 mr-2"></i> Rankings</button>
                <button onclick="switchView('playlists')"
                    class="px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-800 transition-colors text-slate-400 flex items-center"
                    id="tab-playlists"><i data-lucide="list" class="w-4 h-4 mr-2"></i> Lists</button>
                <a href="/guide"
                    class="px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-800 transition-colors text-slate-400 flex items-center"><i
                        data-lucide="book-open" class="w-4 h-4 mr-2"></i> Guide</a>
                <div class="h-6 w-px bg-slate-700 mx-1"></div>
                <!-- Wrapped (only visible Nov 29 - Dec 31) -->
                <button onclick="switchTab('report')"
                    class="px-4 py-2 rounded-lg text-sm font-bold bg-gradient-to-r from-yellow-400 to-pink-500 bg-clip-text text-transparent hover:opacity-80 transition-opacity flex items-center"
                    id="tab-report"><i data-lucide="gift" class="w-4 h-4 mr-2 text-pink-500"></i> 2025 WRAPPED</button>
                <div class="h-6 w-px bg-slate-700 mx-1" id="wrapped-divider"></div>
                <button onclick="logout()" class="text-slate-400 hover:text-white transition-colors" title="Logout">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 pt-8">

        <!-- Stats Row -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
            <div class="glass rounded-2xl p-6">
                <div class="text-slate-400 text-sm font-medium mb-1">Total Watchlist</div>
                <div class="text-3xl font-bold text-white" id="stat-watchlist">0</div>
            </div>
            <div class="glass rounded-2xl p-6">
                <div class="text-slate-400 text-sm font-medium mb-1">Watched</div>
                <div class="text-3xl font-bold text-white" id="stat-watched">0</div>
            </div>
            <div class="glass rounded-2xl p-6">
                <div class="text-slate-400 text-sm font-medium mb-1">Hours Watched</div>
                <div class="text-3xl font-bold text-indigo-400" id="stat-hours">0h</div>
                <div class="text-xs text-slate-500 mt-1" id="stat-hours-breakdown">Movies vs TV</div>
            </div>
            <div class="glass rounded-2xl p-6">
                <div class="text-slate-400 text-sm font-medium mb-1">Avg Time to Watch</div>
                <div class="text-3xl font-bold text-purple-400" id="stat-velocity">0h</div>
            </div>
        </div>

        <!-- Content Area -->
        <div id="view-watchlist" class="view-section">
            <h2 class="text-2xl font-semibold mb-6 flex items-center gap-2">
                <span class="w-1 h-6 bg-indigo-500 rounded-full"></span>
                Up Next
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6" id="watchlist-grid">
                <!-- Items injected here -->
            </div>
        </div>

        <div id="view-history" class="view-section hidden">
            <h2 class="text-2xl font-semibold mb-6 flex items-center gap-2">
                <span class="w-1 h-6 bg-emerald-500 rounded-full"></span>
                Completed
            </h2>
            <!-- Filter Bar -->
            <div id="filter-bar"
                class="mb-6 flex flex-col md:flex-row gap-4 justify-between items-center bg-white/5 p-4 rounded-xl border border-white/5">
                <!-- Type Tabs -->
                <div class="flex gap-2">
                    <button onclick="setFilterType('all')" id="filter-all"
                        class="px-4 py-2 rounded-lg text-sm font-bold bg-indigo-600 text-white transition-colors">All</button>
                    <button onclick="setFilterType('movie')" id="filter-movie"
                        class="px-4 py-2 rounded-lg text-sm font-bold bg-white/10 hover:bg-white/20 text-white transition-colors">Movies</button>
                    <button onclick="setFilterType('tv')" id="filter-tv"
                        class="px-4 py-2 rounded-lg text-sm font-bold bg-white/10 hover:bg-white/20 text-white transition-colors">TV</button>
                    <button onclick="setFilterType('blocked')" id="filter-blocked"
                        class="px-4 py-2 rounded-lg text-sm font-bold bg-white/10 hover:bg-white/20 text-red-400 transition-colors border border-white/5"
                        title="View Anti-Watchlist">
                        <i data-lucide="ban" class="w-4 h-4 inline-block mr-1"></i> Blocked
                    </button>
                </div>

                <!-- Genre Pills -->
                <div class="flex-1 w-full md:w-auto overflow-x-auto pb-2 md:pb-0 no-scrollbar">
                    <div class="flex gap-2" id="genre-filter-list">
                        <!-- Injected via JS -->
                        <div class="text-xs text-slate-500 italic">Loading genres...</div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6" id="history-grid">
                <!-- Items injected here -->
            </div>
        </div>

        <div id="view-analytics" class="view-section hidden">
            <!-- Charts Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- 1. Genres -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-lg font-semibold mb-4 text-slate-300">Top Genres</h3>
                    <div class="h-48">
                        <canvas id="genreChart"></canvas>
                    </div>
                </div>
                <!-- 2. Format Split -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-lg font-semibold mb-4 text-slate-300">Movies vs Series</h3>
                    <div class="h-48">
                        <canvas id="formatChart"></canvas>
                    </div>
                </div>
                <!-- 3. Activity -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-lg font-semibold mb-4 text-slate-300">Watch Activity</h3>
                    <div class="h-48" id="activity-heatmap-container">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
                <!-- 4. Eras -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-lg font-semibold mb-4 text-slate-300">Eras (Decades)</h3>
                    <div class="h-48">
                        <canvas id="eraChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- NEW: Deep Dive Analytics -->
            <div class="mb-8">
                <h3 class="text-xl font-bold mb-4 text-white flex items-center gap-2">
                    <i data-lucide="brain" class="w-5 h-5 text-purple-400"></i> Deep Dive
                </h3>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Stats Cards -->
                    <div class="space-y-4">
                        <div class="glass rounded-2xl p-6 flex items-center justify-between">
                            <div>
                                <div class="text-xs text-slate-400 uppercase tracking-widest mb-1">Completion Rate</div>
                                <div class="text-3xl font-black text-emerald-400" id="stat-completion">0%</div>
                            </div>
                            <div class="opacity-20"><i data-lucide="target" class="w-8 h-8"></i></div>
                        </div>
                        <div class="glass rounded-2xl p-6 flex items-center justify-between">
                            <div>
                                <div class="text-xs text-slate-400 uppercase tracking-widest mb-1">Avg Rating</div>
                                <div class="text-3xl font-black text-yellow-400" id="stat-rating">0.0</div>
                            </div>
                            <div class="opacity-20"><i data-lucide="star" class="w-8 h-8"></i></div>
                        </div>
                        <div class="glass rounded-2xl p-6 flex items-center justify-between">
                            <div>
                                <div class="text-xs text-slate-400 uppercase tracking-widest mb-1">Masterpieces</div>
                                <div class="text-3xl font-black text-indigo-400" id="stat-perfect">0</div>
                            </div>
                            <div class="opacity-20"><i data-lucide="gem" class="w-8 h-8"></i></div>
                        </div>
                    </div>
                    <!-- Runtime Chart -->
                    <div class="glass rounded-2xl p-6 col-span-2">
                        <h3 class="text-lg font-semibold mb-4 text-slate-300">Runtime Preference</h3>
                        <div class="h-64">
                            <canvas id="runtimeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW: Bi-Weekly Sprint Report -->
            <div class="glass rounded-2xl p-8 mb-8 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-32 bg-blue-500/10 rounded-full blur-3xl pointer-events-none"></div>
                <div class="relative z-10">
                    <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                        <i data-lucide="zap" class="w-6 h-6 text-blue-400 mr-2"></i> SPRINT REPORT (Last 14 Days)
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <div class="flex items-baseline gap-2 mb-2">
                                <span class="text-5xl font-black text-white" id="sprint-hours">0</span>
                                <span class="text-xl text-slate-400">hours</span>
                            </div>
                            <p class="text-sm text-slate-400 mb-6" id="sprint-label">You've been active!</p>
                            <div class="flex gap-4 text-center">
                                <div class="bg-white/5 rounded-lg p-3 flex-1">
                                    <div class="text-2xl font-bold text-white" id="sprint-count">0</div>
                                    <div class="text-xs text-slate-500 uppercase tracking-wider">Items</div>
                                </div>
                                <div class="bg-white/5 rounded-lg p-3 flex-1">
                                    <div class="text-2xl font-bold text-white" id="sprint-minutes">0</div>
                                    <div class="text-xs text-slate-500 uppercase tracking-wider">Minutes</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-black/20 rounded-xl p-4">
                            <h4 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-3">Checklist</h4>
                            <ul class="space-y-2 max-h-48 overflow-y-auto" id="sprint-list">
                                <!-- Injected -->
                                <li class="text-slate-500 italic text-sm">No activity in this sprint.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coming Soon -->
            <div class="mb-8">
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <i data-lucide="rocket" class="w-6 h-6 text-purple-400 mr-2"></i> Upcoming & On Air
                </h3>
                <div class="flex gap-4 overflow-x-auto pb-4 snap-x no-scrollbar" id="coming-soon-list">
                    <!-- Injected -->
                    <div
                        class="shrink-0 w-40 h-60 bg-white/5 rounded-xl flex items-center justify-center animate-pulse">
                        Loading...</div>
                </div>
            </div>

            <!-- Recommendations -->
            <div class="glass rounded-2xl p-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold">Recommendations</h3>
                    <button onclick="refreshRecommendations()"
                        class="px-3 py-1 bg-white/10 hover:bg-white/20 rounded-lg text-sm transition-colors flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path
                                d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3" />
                        </svg>
                        Refresh
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="recommendations-list">
                    <!-- Recs injected here -->
                </div>
            </div>
        </div>

        <div id="view-social" class="view-section hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left: Search & Your Friends -->
                <div class="space-y-6">
                    <!-- Profile Card -->
                    <div class="glass rounded-2xl p-6 text-center relative group">
                        <img src="" id="my-profile-pic" onclick="if(currentUser) openEditProfile()"
                            class="w-20 h-20 rounded-full mx-auto mb-3 border-2 border-indigo-500 shadow-lg cursor-pointer hover:scale-105 transition-transform">
                        <h3 class="text-xl font-bold text-white" id="my-profile-name">...</h3>
                        <p class="text-sm text-slate-400 mb-4" id="my-profile-bio">No bio yet.</p>
                        <button onclick="openEditProfile()"
                            class="text-xs bg-white/10 hover:bg-white/20 px-3 py-1 rounded-full transition-colors text-white">Edit
                            Profile</button>
                    </div>

                    <div class="glass rounded-2xl p-6">
                        <h3 class="text-lg font-semibold mb-4 text-white">Friend Activity</h3>
                        <div class="relative">
                            <input type="text" id="user-search-input" placeholder="Search by name..."
                                class="w-full bg-slate-800 border-none rounded-lg py-3 px-4 text-white focus:ring-2 focus:ring-indigo-500 pl-10"
                                onkeyup="handleUserSearch(this.value)">

                        </div>
                        <div id="user-search-results" class="mt-4 space-y-2 max-h-60 overflow-y-auto hidden">
                            <!-- Results -->
                        </div>

                        <!-- NEW: Following List -->
                        <div class="mt-8 border-t border-white/10 pt-6">
                            <h4 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">Your Friends
                            </h4>
                            <div id="following-list" class="space-y-3">
                                <!-- Injected -->
                                <div class="text-slate-500 text-xs italic">Loading friends...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Activity Feed -->
                <div class="lg:col-span-2">
                    <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                        Friend Activity
                    </h3>
                    <div class="space-y-4" id="social-feed-list">
                        <!-- Feed Items -->
                        <div class="text-center text-slate-500 py-10">Follow friends to see what they're watching!</div>
                    </div>

                    <!-- Watch Parties Section -->
                    <div class="mt-12 border-t border-white/10 pt-8">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold flex items-center gap-2">
                                <i data-lucide="party-popper" class="text-pink-500 w-6 h-6"></i> Watch Parties
                            </h3>
                            <button onclick="document.getElementById('host-party-modal').classList.remove('hidden')"
                                class="text-sm bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-lg text-white transition-colors flex items-center gap-1">
                                <i data-lucide="plus" class="w-4 h-4"></i> Host Party
                            </button>
                        </div>
                        <div id="party-list" class="space-y-3">
                            <!-- Injected -->
                            <div class="text-slate-500 text-center py-6 italic">Loading parties...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-playlists" class="view-section hidden">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-semibold flex items-center gap-2">
                    <span class="w-1 h-6 bg-indigo-500 rounded-full"></span>
                    My Playlists
                </h2>
                <button onclick="openCreatePlaylistModal()"
                    class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg font-bold transition-colors">
                    + New Playlist
                </button>
            </div>

            <div id="playlists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Injected via JS -->
                <div class="text-slate-500 italic">Loading playlists...</div>
            </div>
        </div>

        <div id="view-leaderboard" class="view-section hidden">
            <div class="glass rounded-2xl p-8 overflow-hidden">
                <h3 class="text-lg font-semibold mb-6 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="text-yellow-400">
                        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                        <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                        <path d="M4 22h16"></path>
                        <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
                        <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
                        <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
                    </svg>
                    Global Rankings
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="text-slate-400 border-b border-slate-700">
                                <th class="p-4 font-medium">Rank</th>
                                <th class="p-4 font-medium">Watcher</th>
                                <th class="p-4 font-medium">Time</th>
                                <th class="p-4 font-medium">Vibe</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-list">
                            <!-- Injected -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-report" class="view-section hidden">
            <!-- Wrapped Content -->
            <div class="max-w-md mx-auto space-y-6 pb-20 pt-4">

                <!-- Intro Card -->
                <div
                    class="animate-up aspect-[4/5] bg-gradient-to-br from-indigo-600 via-purple-700 to-fuchsia-600 rounded-[2rem] p-8 flex flex-col justify-between shadow-2xl shadow-purple-900/50 relative overflow-hidden group">
                    <div
                        class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-20 mix-blend-overlay">
                    </div>
                    <div
                        class="absolute -top-24 -right-24 w-64 h-64 bg-pink-500 rounded-full blur-[80px] opacity-40 group-hover:opacity-60 transition-opacity duration-1000">
                    </div>
                    <div class="relative z-10">
                        <div
                            class="text-xs font-bold tracking-[0.3em] text-white/70 uppercase mb-2 border-b border-white/10 pb-2 flex justify-between items-center">
                            <span>2025 Seasonal Report</span>
                            <span id="report-rank"
                                class="bg-white/20 px-2 py-0.5 rounded text-[10px] tracking-normal">Top 1%</span>
                        </div>
                        <h2 class="text-6xl font-black text-white leading-[0.9] tracking-tighter mt-2">
                            YOUR<br>WATCH<br>VIBE</h2>
                    </div>
                    <div class="relative z-10">
                        <div class="text-7xl font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-white/60"
                            id="report-vibe">...</div>
                        <div class="text-white/80 font-medium mt-2 flex items-center gap-2">
                            <span class="bg-white/20 p-1 rounded-full text-xs">‚ú®</span> is your top genre
                        </div>
                    </div>
                </div>

                <!-- Trivia Card -->
                <div class="animate-up delay-100 bg-white text-black p-6 rounded-3xl shadow-xl transform rotate-1 hover:rotate-0 transition-transform duration-300 relative overflow-hidden"
                    id="report-trivia-card">
                    <div class="absolute -right-4 -bottom-8 text-[10rem] text-slate-100 font-black z-0 leading-none">?
                    </div>
                    <div class="relative z-10">
                        <h3 class="text-[0.6rem] font-black uppercase tracking-widest text-indigo-600 mb-2">Did You
                            Know?</h3>
                        <p class="text-2xl font-bold leading-tight" id="report-trivia-text">Populating your trivia...
                        </p>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div
                    class="animate-up delay-200 bg-gradient-to-br from-emerald-500 to-teal-700 rounded-3xl p-8 text-white shadow-2xl relative overflow-hidden">
                    <div class="absolute -right-10 -top-10 w-40 h-40 bg-white/20 rounded-full blur-3xl"></div>
                    <h3 class="font-black text-3xl mb-8 uppercase tracking-tight opacity-90">The Stats</h3>
                    <div class="space-y-4 relative z-10">
                        <div class="flex justify-between items-end border-b border-white/20 pb-2">
                            <span class="font-bold text-xs tracking-widest uppercase opacity-70">Minutes</span>
                            <span class="font-black text-4xl" id="report-minutes">0</span>
                        </div>
                        <div class="flex justify-between items-end border-b border-white/20 pb-2">
                            <span class="font-bold text-xs tracking-widest uppercase opacity-70">Movies</span>
                            <span class="font-black text-4xl" id="report-movies">0</span>
                        </div>
                        <div class="flex justify-between items-end border-b border-white/20 pb-2">
                            <span class="font-bold text-xs tracking-widest uppercase opacity-70">Series</span>
                            <span class="font-black text-4xl" id="report-series">0</span>
                        </div>
                    </div>
                </div>

                <!-- Top Lists (Spotify Style) -->
                <div
                    class="animate-up delay-300 bg-black/40 backdrop-blur-md border border-white/10 rounded-3xl p-8 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-24 bg-yellow-500 rounded-full blur-[80px] opacity-20"></div>
                    <h3 class="relative z-10 font-bold text-2xl mb-6 text-white flex items-center gap-3">
                        <span
                            class="flex items-center justify-center w-8 h-8 bg-yellow-400 text-black text-sm font-black rounded-full">#1</span>
                        Top Genres
                    </h3>
                    <ul class="relative z-10 space-y-3" id="report-genres-list"></ul>
                </div>

                <!-- Top Studios -->
                <div
                    class="animate-up delay-400 bg-black/40 backdrop-blur-md border border-white/10 rounded-3xl p-8 relative overflow-hidden">
                    <div class="absolute bottom-0 left-0 p-24 bg-blue-500 rounded-full blur-[80px] opacity-20"></div>
                    <h3 class="relative z-10 font-bold text-2xl mb-6 text-white flex items-center gap-3">
                        <span
                            class="flex items-center justify-center w-8 h-8 bg-blue-400 text-black text-sm font-black rounded-full">#2</span>
                        Favorite Studios
                    </h3>
                    <ul class="relative z-10 space-y-3" id="report-studios-list"></ul>
                </div>

                <!-- Top Cast -->
                <div
                    class="animate-up delay-500 bg-black/40 backdrop-blur-md border border-white/10 rounded-3xl p-8 relative overflow-hidden">
                    <div class="absolute top-0 left-0 p-24 bg-purple-500 rounded-full blur-[80px] opacity-20"></div>
                    <h3 class="relative z-10 font-bold text-2xl mb-6 text-white flex items-center gap-3">
                        <span
                            class="flex items-center justify-center w-8 h-8 bg-purple-400 text-black text-sm font-black rounded-full">#3</span>
                        Starring Agents
                    </h3>
                    <ul class="relative z-10 space-y-3" id="report-cast-list"></ul>
                </div>

                <!-- Vibe Cloud -->
                <div class="animate-up delay-600 glass rounded-3xl p-6 relative overflow-hidden text-center">
                    <h3 class="font-black text-xl mb-4 text-white uppercase tracking-widest opacity-80">Sub-Genre DNA
                    </h3>
                    <div class="flex flex-wrap gap-2 justify-center" id="report-keywords-list"></div>
                </div>

                <!-- Temporal Cards (Month & Day) -->
                <div class="grid grid-cols-2 gap-4">
                    <div
                        class="animate-up delay-600 bg-gradient-to-br from-orange-400 to-red-500 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
                        <div class="absolute -right-4 -bottom-4 text-8xl opacity-20">üìÖ</div>
                        <h3 class="font-bold text-xs uppercase tracking-widest opacity-80 mb-2">Peak Month</h3>
                        <div class="text-3xl font-black" id="report-month">...</div>
                        <div class="text-sm opacity-90 mt-1" id="report-month-count">0 items</div>
                    </div>
                    <div
                        class="animate-up delay-600 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
                        <div class="absolute -right-4 -bottom-4 text-8xl opacity-20">‚è∞</div>
                        <h3 class="font-bold text-xs uppercase tracking-widest opacity-80 mb-2">Fav Day</h3>
                        <div class="text-3xl font-black" id="report-day">...</div>
                        <div class="text-sm opacity-90 mt-1" id="report-day-count">0 items</div>
                    </div>
                </div>

                <!-- Global Rank Card -->
                <div
                    class="animate-up delay-600 aspect-square bg-white text-black rounded-3xl p-8 flex flex-col items-center justify-center text-center shadow-2xl relative overflow-hidden">
                    <div
                        class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/diagmonds-light.png')] opacity-50">
                    </div>
                    <div class="relative z-10">
                        <div class="text-sm font-bold uppercase tracking-widest text-slate-500 mb-2">Global Ranking
                        </div>
                        <div class="text-9xl font-black tracking-tighter text-black" id="report-rank">#?</div>
                        <div class="mt-4 inline-block bg-black text-white px-4 py-1 rounded-full text-sm font-bold">Top
                            1% Viewer</div>
                    </div>
                </div>

            </div>
        </div>

        <!-- DATE / RATING MODAL -->
        <div id="date-modal"
            class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
            <div class="bg-slate-900 border border-white/10 rounded-2xl w-full max-w-sm p-6 relative animate-pop">
                <button onclick="document.getElementById('date-modal').classList.add('hidden')"
                    class="absolute top-4 right-4 text-slate-500 hover:text-white">‚úï</button>
                <h2 class="text-xl font-bold text-white mb-4">You watched it?</h2>

                <label class="block text-sm text-slate-400 mb-2">When?</label>
                <input type="date" id="watched-date-input"
                    class="w-full bg-black/50 border border-white/10 rounded-lg p-3 text-white mb-4 focus:ring-2 focus:ring-indigo-500 outline-none">

                <label class="block text-sm text-slate-400 mb-2">Rate it</label>
                <div class="flex gap-2 mb-6" id="rating-stars-input">
                    <button onclick="setRating(1)"
                        class="text-2xl text-slate-600 hover:text-yellow-400 transition-colors">‚òÖ</button>
                    <button onclick="setRating(2)"
                        class="text-2xl text-slate-600 hover:text-yellow-400 transition-colors">‚òÖ</button>
                    <button onclick="setRating(3)"
                        class="text-2xl text-slate-600 hover:text-yellow-400 transition-colors">‚òÖ</button>
                    <button onclick="setRating(4)"
                        class="text-2xl text-slate-600 hover:text-yellow-400 transition-colors">‚òÖ</button>
                    <button onclick="setRating(5)"
                        class="text-2xl text-slate-600 hover:text-yellow-400 transition-colors">‚òÖ</button>
                </div>

                <button onclick="confirmWatch()"
                    class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-indigo-500/20">
                    Confirm
                </button>
            </div>
        </div>

        <script>
            let currentRating = 0;
            let activeTmdbId = null;

            function setRating(r) {
                currentRating = r;
                const btns = document.getElementById('rating-stars-input').children;
                for (let i = 0; i < 5; i++) {
                    btns[i].classList.remove('text-yellow-400', 'text-slate-600');
                    if (i < r) btns[i].classList.add('text-yellow-400');
                    else btns[i].classList.add('text-slate-600');
                }
            }

            function openRateModal(id, title) {
                // For editing rating of already watched item
                activeTmdbId = id;
                document.getElementById('date-modal').classList.remove('hidden');
                document.querySelector('#date-modal h2').innerText = `Rate ${title}`;
                // Allow date edit
                document.getElementById('watched-date-input').classList.remove('hidden');
            }

            function openDateModal(id) {
                activeTmdbId = id;
                document.getElementById('watched-date-input').classList.remove('hidden');
                document.getElementById('watched-date-input').valueAsDate = new Date();
                setRating(0);
                document.getElementById('date-modal').classList.remove('hidden');
                document.querySelector('#date-modal h2').innerText = "You watched it?";
            }

            async function confirmWatch() {
                if (!activeTmdbId) return;
                const dateVal = document.getElementById('watched-date-input').value;

                // 1. Move to Watched (if date visible/needed)
                if (!document.getElementById('watched-date-input').classList.contains('hidden')) {
                    await authFetch(`/api/log/${activeTmdbId}/status`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'watched', date: dateVal })
                    });
                }

                // 2. Set Rating (if selected)
                if (currentRating > 0) {
                    await authFetch(`/api/log/${activeTmdbId}/rating?rating=${currentRating}`, {
                        method: 'PUT'
                    });
                }

                // 3. Share to Google (Mock) if rating is high?
                if (currentRating >= 4) {
                    // Optional: Prompt share
                }

                document.getElementById('date-modal').classList.add('hidden');
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
                init(); // Refresh
            }
        </script>
        <div id="drilldown-modal"
            class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4">
            <div
                class="bg-[#1a1a1a] w-full max-w-4xl max-h-[90vh] rounded-3xl overflow-hidden flex flex-col shadow-2xl border border-white/10">
                <div class="p-6 border-b border-white/10 flex justify-between items-center bg-black/40">
                    <h2 class="text-2xl font-black text-white flex items-center gap-3">
                        <span id="drilldown-title">Details</span>
                    </h2>
                    <button onclick="document.getElementById('drilldown-modal').classList.add('hidden')"
                        class="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition-colors text-white">
                        ‚úï
                    </button>
                </div>
                <div class="p-6 overflow-y-auto flex-1 custom-scrollbar">
                    <div id="drilldown-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        <!-- Injected -->
                    </div>
                </div>
            </div>
        </div>
        </div>

    </main>

    <script>
        function logout() {
            // Clear Token
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_info');

            // Clear Cookie (set max-age=0)
            document.cookie = "access_token=; path=/; max-age=0; SameSite=None; Secure";
            document.cookie = "access_token=; path=/; max-age=0"; // Fallback for stricter paths

            // Redirect
            window.location.href = '/login.html';
        }
    </script>



    <!-- MANUAL ADD MODAL -->
    <!-- Edit Progress Modal (TV) -->
    <div id="edit-progress-modal"
        class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center backdrop-blur-md">
        <div
            class="bg-[#0f172a] rounded-3xl w-full max-w-4xl h-[80vh] mx-4 border border-slate-700 shadow-2xl relative flex overflow-hidden">
            <button onclick="closeProgressModal()"
                class="absolute top-4 right-4 z-10 text-slate-400 hover:text-white bg-black/50 rounded-full p-2 transition-colors">‚úï</button>
            <div class="w-1/3 border-r border-slate-700 flex flex-col bg-slate-900/50">
                <div class="p-6 border-b border-slate-700">
                    <h2 class="text-2xl font-black text-white mb-1" id="progress-modal-title">Show Title</h2>
                    <p class="text-xs text-indigo-400 uppercase tracking-widest font-bold">Select Season</p>
                </div>
                <div id="progress-seasons-list" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar"></div>
            </div>
            <div class="w-2/3 flex flex-col bg-[#0f172a]">
                <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-bold text-white" id="progress-season-title">Season 1</h3>
                        <p class="text-sm text-slate-400" id="progress-season-meta">...</p>
                    </div>
                    <button onclick="markSeasonWatched()"
                        class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold rounded-lg transition-colors">Mark
                        Season Watched</button>
                </div>
                <div id="progress-episodes-list" class="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar"></div>
            </div>
        </div>
    </div>

    <!-- Inbox Modal -->
    <div id="inbox-modal"
        class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="glass p-8 rounded-3xl max-w-lg w-full mx-4 relative overflow-hidden flex flex-col max-h-[80vh]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-white flex items-center gap-2"><i data-lucide="inbox"
                        class="w-8 h-8 text-indigo-500"></i> Inbox</h2>
                <button onclick="document.getElementById('inbox-modal').classList.add('hidden')"
                    class="text-slate-400 hover:text-white text-xl">‚úï</button>
            </div>
            <div id="inbox-list" class="space-y-3 overflow-y-auto flex-1 pr-2"></div>
        </div>
    </div>


    <!-- USER PROFILE MODAL -->
    <div id="user-profile-modal"
        class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center backdrop-blur-md">
        <div class="glass rounded-3xl w-full max-w-2xl mx-4 p-8 relative overflow-hidden animate-in">
            <button onclick="document.getElementById('user-profile-modal').classList.add('hidden')"
                class="absolute top-4 right-4 text-slate-400 hover:text-white bg-white/10 rounded-full p-2 transition-colors"><i
                    data-lucide="x" class="w-5 h-5"></i></button>

            <div id="user-profile-content" class="flex flex-col items-center">
                <!-- Loading state -->
                <div class="animate-pulse flex flex-col items-center space-y-4 w-full">
                    <div class="w-24 h-24 bg-white/10 rounded-full"></div>
                    <div class="h-6 w-32 bg-white/10 rounded"></div>
                    <div class="h-4 w-48 bg-white/10 rounded"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Playlist Modal -->
    <div id="create-playlist-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center">
        <div
            class="bg-[#1e293b] rounded-2xl p-8 max-w-md w-full mx-4 border border-slate-700 shadow-2xl relative animate-in">
            <button onclick="document.getElementById('create-playlist-modal').classList.add('hidden')"
                class="absolute top-4 right-4 text-slate-400 hover:text-white">‚úï</button>
            <h3 class="text-2xl font-bold mb-6 text-white flex items-center gap-2"><i data-lucide="folder-plus"
                    class="text-indigo-400 w-6 h-6"></i> New Playlist</h3>
            <div class="space-y-4">
                <input type="text" id="new-playlist-name" placeholder="Name e.g. Weekend Binge"
                    class="w-full bg-slate-800 border-none rounded-lg py-3 px-4 text-white">


                <textarea id="new-playlist-desc" rows="3" placeholder="Description..."
                    class="w-full bg-slate-800 border-none rounded-lg py-3 px-4 text-white"></textarea>
                <div class="flex items-center gap-3 bg-white/5 p-3 rounded-lg">
                    <input type="checkbox" id="new-playlist-public" checked
                        class="w-5 h-5 rounded text-indigo-500 bg-slate-700 border-none">
                    <div class="text-sm font-bold text-white">Public Playlist</div>
                </div>
                <button onclick="submitCreatePlaylist()"
                    class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-500/20 mt-2">Create
                    Playlist</button>
            </div>
        </div>
    </div>

    <!-- Playlist Details Modal -->
    <div id="playlist-details-modal"
        class="fixed inset-0 bg-black/90 backdrop-blur-md hidden z-50 flex items-center justify-center">
        <div
            class="bg-[#0f172a] rounded-3xl w-full max-w-4xl h-[80vh] mx-4 border border-slate-700 shadow-2xl relative flex flex-col overflow-hidden">
            <!-- Header -->
            <div class="p-8 border-b border-white/10 flex justify-between items-start bg-slate-900/50">
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        <i data-lucide="folder" class="w-8 h-8 text-indigo-500"></i>
                        <h2 class="text-3xl font-black text-white" id="playlist-detail-name">Loading...</h2>
                    </div>
                    <p class="text-slate-400 max-w-xl" id="playlist-detail-desc">...</p>
                    <div class="flex gap-3 mt-4">
                        <button id="playlist-share-btn"
                            class="flex items-center gap-2 px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-xs font-bold text-white transition-colors"><i
                                data-lucide="share-2" class="w-3 h-3"></i>
                            Share</button>
                        <button id="playlist-collab-btn" onclick="openCollaborateModal(playlist.id)"
                            class="flex items-center gap-2 px-3 py-1.5 bg-pink-600 hover:bg-pink-500 rounded-lg text-xs font-bold text-white transition-colors"><i
                                data-lucide="users" class="w-3 h-3"></i>
                            Collaborate</button>
                        <button id="playlist-delete-btn"
                            class="flex items-center gap-2 px-3 py-1.5 bg-red-500/10 hover:bg-red-500/20 text-red-500 rounded-lg text-xs font-bold transition-colors border border-red-500/20"><i
                                data-lucide="trash-2" class="w-3 h-3"></i>
                            Delete</button>
                    </div>
                </div>
                <button onclick="document.getElementById('playlist-details-modal').classList.add('hidden')"
                    class="text-slate-400 hover:text-white bg-white/5 rounded-full p-2 transition-colors">‚úï</button>
            </div>
            <div class="flex-1 flex overflow-hidden">
                <div class="flex-1 overflow-y-auto p-8 custom-scrollbar relative">
                    <div id="playlist-detail-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    <div id="playlist-empty-state"
                        class="hidden flex flex-col items-center justify-center h-64 text-slate-500"><span
                            class="text-4xl mb-4">üì≠</span>
                        <p>Empty</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add To Playlist Modal -->
    <div id="add-to-playlist-modal"
        class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div
            class="bg-[#1e293b] rounded-2xl p-6 max-w-sm w-full mx-4 border border-slate-700 shadow-2xl relative animate-in">
            <button onclick="document.getElementById('add-to-playlist-modal').classList.add('hidden')"
                class="absolute top-4 right-4 text-slate-400 hover:text-white">‚úï</button>
            <h3 class="text-xl font-bold mb-4 text-white flex items-center gap-2"><i data-lucide="plus"
                    class="text-indigo-400 w-5 h-5"></i>
                Add to Playlist</h3>
            <div id="add-to-playlist-list" class="space-y-2 max-h-60 overflow-y-auto pr-1"></div>
            <button
                onclick="document.getElementById('add-to-playlist-modal').classList.add('hidden'); openCreatePlaylistModal()"
                class="w-full mt-4 py-3 border border-indigo-500/30 hover:bg-indigo-500/10 text-indigo-400 rounded-xl font-bold transition-colors text-sm flex items-center justify-center gap-2"><i
                    data-lucide="plus" class="w-4 h-4"></i>
                Create New Playlist</button>
        </div>
    </div>

    <!-- Host Party Modal -->
    <div id="host-party-modal"
        class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="glass p-8 rounded-3xl max-w-sm w-full mx-4 relative overflow-hidden">
            <h2 class="text-xl font-bold text-white mb-4">Host a Watch Party</h2>
            <input type="text" id="host-party-title"
                class="w-full bg-slate-800 border-none rounded-xl px-4 py-3 text-white mb-4" placeholder="Movie Title">
            <input type="number" id="host-party-id"
                class="w-full bg-slate-800 border-none rounded-xl px-4 py-3 text-white mb-4"
                placeholder="TMDB ID (Optional)">
            <input type="datetime-local" id="host-party-date"
                class="w-full bg-slate-800 border-none rounded-xl px-4 py-3 text-white mb-4 [color-scheme:dark]">
            <div class="flex gap-2">
                <button onclick="document.getElementById('host-party-modal').classList.add('hidden')"
                    class="flex-1 py-3 font-bold text-slate-400 hover:text-white transition-colors">Cancel</button>
                <button onclick="submitHostParty()"
                    class="flex-1 bg-pink-600 hover:bg-pink-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-pink-500/20">Host
                    It</button>
            </div>
        </div>
    </div>

    <!-- Collaborate Modal -->
    <div id="collaborate-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50">
        <div
            class="bg-slate-900 border border-slate-700 rounded-2xl p-6 w-[500px] max-w-full m-4 shadow-2xl animate-scaleIn">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="users"
                            class="text-pink-400"></i> Collaboration</h2>
                    <p class="text-slate-400 text-xs mt-1">Add friends to edit this playlist with you.</p>
                </div>
                <button onclick="document.getElementById('collaborate-modal').classList.add('hidden')"
                    class="text-slate-400 hover:text-white">
                    <i data-lucide="x"></i>
                </button>
            </div>

            <input type="text" id="collab-search" placeholder="Search user to add..."
                class="w-full bg-slate-800 border-slate-700 rounded-xl p-3 text-white mb-4 focus:ring-2 focus:ring-pink-500 outline-none transition-all"
                onkeyup="searchCollaborators(this.value)">

            <div id="collab-results" class="space-y-2 max-h-[300px] overflow-y-auto custom-scrollbar">
                <!-- Results go here -->
                <div class="text-center text-slate-500 py-8">Start typing to find friends...</div>
            </div>
        </div>
    </div>

    <!-- Send Rec Modal -->
    <div id="send-rec-modal"
        class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="glass p-8 rounded-3xl max-w-sm w-full mx-4 relative overflow-hidden">
            <h2 class="text-xl font-bold text-white mb-4">Send to Friend</h2>
            <input type="hidden" id="send-rec-content-id">
            <select id="send-rec-user"
                class="w-full bg-slate-800 border-none rounded-xl px-4 py-3 text-white mb-4"></select>
            <textarea id="send-rec-msg"
                class="w-full bg-slate-800 border-none rounded-xl px-4 py-3 text-white mb-4 h-24 resize-none"
                placeholder="Message..."></textarea>
            <button onclick="submitRecommendation()"
                class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl">Send</button>
        </div>
    </div>

    <div id="add-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-white/10 rounded-2xl w-full max-w-md p-6 relative animate-pop">
            <button onclick="closeAddModal()" class="absolute top-4 right-4 text-slate-500 hover:text-white">‚úï</button>
            <h2 class="text-xl font-bold text-white mb-4">Add to Watchlist</h2>
            <div class="space-y-4">
                <div class="relative">
                    <input type="text" id="add-search" placeholder="Search for Movie or TV Show..."
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-indigo-500 mb-2"
                        oninput="debounceSearchv2()">
                    <!-- Results Dropdown -->
                    <div id="add-search-results"
                        class="absolute left-0 right-0 top-full mt-1 bg-slate-800 border border-slate-700 rounded-lg shadow-xl max-h-60 overflow-y-auto hidden z-50">
                    </div>
                </div>

                <!-- Selected Item Preview -->
                <div id="selected-preview"
                    class="hidden flex items-center gap-3 bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                    <img id="selected-poster" src="" class="w-10 h-14 rounded object-cover shadow">
                    <div>
                        <h4 id="selected-title" class="font-bold text-white text-sm"></h4>
                        <div class="text-xs text-slate-400" id="selected-meta"></div>
                    </div>
                    <button onclick="clearSelection()" class="ml-auto text-slate-400 hover:text-white">‚úï</button>
                </div>

                <input type="hidden" id="selected-tmdb-id">
                <input type="hidden" id="selected-media-type">

                <div class="flex gap-2">
                    <select id="add-status" class="bg-slate-800 border-slate-700 rounded-lg p-3 text-white w-full"
                        onchange="toggleDateInput()">
                        <option value="watchlist">Watchlist</option>
                        <option value="watched">Watched</option>
                        <option value="blocked">Blocked üö´</option>
                    </select>
                </div>
                <div class="text-center">
                    <p class="text-xs text-slate-500">Importing from Google? <br> Go to <a
                            href="https://google.com/save" target="_blank"
                            class="text-indigo-400 hover:text-indigo-300">google.com/save</a> and use the extension
                        button.</p>
                </div>
                <div id="add-date-container" class="hidden">
                    <label class="text-xs text-slate-400 block mb-1">Date Watched (Optional)</label>
                    <input type="date" id="add-date"
                        class="w-full bg-slate-800 border-slate-700 rounded-lg p-3 text-white">
                </div>
                <button onclick="submitManualAdd()"
                    class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg shadow-lg shadow-indigo-500/20 transition-all">
                    Add Selection to Library
                </button>
            </div>

        </div>
    </div>

    <!-- PROFILE MODAL (RESTORED) -->
    <div id="edit-profile-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-white/10 rounded-2xl w-full max-w-md p-6 relative">
            <button onclick="document.getElementById('edit-profile-modal').classList.add('hidden')"
                class="absolute top-4 right-4 text-slate-500 hover:text-white">‚úï</button>
            <h2 class="text-xl font-bold text-white mb-4">Edit Profile</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Name</label>
                    <input type="text" id="edit-name"
                        class="w-full bg-slate-800 border-none rounded-lg p-3 text-white focus:ring-2 focus:ring-indigo-500"
                        placeholder="Display Name">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Bio</label>
                    <textarea id="edit-bio" rows="3"
                        class="w-full bg-slate-800 border-none rounded-lg p-3 text-white focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Profile Picture
                        URL</label>
                    <input type="file" id="edit-pic-file" accept="image/*"
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2 text-white text-xs mb-2 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700">
                    <input type="text" id="edit-pic"
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-indigo-500 mb-4 text-xs"
                        placeholder="Or paste image link...">
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label
                            class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">City</label>
                        <input type="text" id="edit-city"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-indigo-500 text-sm"
                            placeholder="e.g. Lagos">
                    </div>
                    <div>
                        <label
                            class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Country</label>
                        <input type="text" id="edit-country"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-indigo-500 text-sm"
                            placeholder="e.g. Nigeria">
                    </div>
                </div>

                <!-- Privacy Toggle -->
                <div class="mt-4 p-4 bg-white/5 rounded-xl border border-white/10">
                    <div class="flex items-center justify-between">
                        <div>
                            <label class="block text-sm font-bold text-white mb-1">Public Profile</label>
                            <p class="text-xs text-slate-400">Show me in global leaderboards</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="edit-is-public" class="sr-only peer">
                            <div
                                class="w-11 h-6 bg-slate-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600">
                            </div>
                        </label>
                    </div>
                </div>
            </div>
            <button onclick="submitProfileEdit()"
                class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg shadow-lg shadow-indigo-500/20 transition-all mt-4">
                Save Profile
            </button>

            <div class="mt-8 pt-6 border-t border-white/10">
                <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Export & Share</h4>
                <div class="space-y-3">
                    <div class="flex gap-2 items-center">
                        <span class="text-xs text-slate-400 w-16">Watchlist</span>
                        <button onclick="exportData('watchlist', 'csv')"
                            class="flex-1 py-2 bg-slate-800 hover:bg-slate-700 rounded text-xs font-bold transition-colors">CSV</button>
                        <button onclick="exportData('watchlist', 'html')"
                            class="flex-1 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded text-xs font-bold transition-colors">Share
                            Page</button>
                    </div>
                    <div class="flex gap-2 items-center">
                        <span class="text-xs text-slate-400 w-16">History</span>
                        <button onclick="exportData('history', 'csv')"
                            class="flex-1 py-2 bg-slate-800 hover:bg-slate-700 rounded text-xs font-bold transition-colors">CSV</button>
                        <button onclick="exportData('history', 'html')"
                            class="flex-1 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded text-xs font-bold transition-colors">Share
                            Page</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    </div>

    <!-- DATE PICKER MODAL for "Mark Watched" -->
    <div id="mark-watched-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-white/10 rounded-2xl w-full max-w-sm p-6 relative animate-pop">
            <button onclick="closeMarkWatchedModal()"
                class="absolute top-4 right-4 text-slate-500 hover:text-white">‚úï</button>
            <h2 class="text-xl font-bold text-white mb-4">When did you watch this?</h2>
            <div class="space-y-4">
                <input type="date" id="status-date"
                    class="w-full bg-slate-800 border-slate-700 rounded-lg p-3 text-white">
                <div class="flex gap-2">
                    <button onclick="confirmMarkWatched()"
                        class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg">Confirm</button>
                    <button onclick="skipDateMarkWatched()"
                        class="flex-1 bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 rounded-lg">Today</button>
                </div>
            </div>
        </div>
    </div>

    <!-- STORY MODE OVERLAY -->
    <div id="story-overlay" class="fixed inset-0 z-[100] bg-black hidden flex-col">
        <!-- Progress Header -->
        <div id="story-progress-container" class="absolute top-4 left-4 right-4 flex gap-2 z-20">
            <!-- Bars injected here -->
        </div>

        <!-- Controls -->
        <button onclick="StoryManager.close()"
            class="absolute top-8 right-6 z-30 text-white/50 hover:text-white">‚úï</button>
        <div class="absolute inset-0 flex z-10">
            <div class="w-1/3 h-full" onclick="StoryManager.prev()"></div>
            <div class="w-1/3 h-full" onmousedown="StoryManager.pause()" onmouseup="StoryManager.resume()"
                ontouchstart="StoryManager.pause()" ontouchend="StoryManager.resume()"></div>
            <!-- Center hold to pause -->
            <div class="w-1/3 h-full" onclick="StoryManager.next()"></div>
        </div>

        <!-- Slide Content -->
        <div id="story-content" class="flex-1 flex flex-col items-center justify-center p-6 relative overflow-hidden">
            <!-- Slide Injected Here -->
        </div>
    </div>

    <script>
        // --- API Client ---
        // Use relative path for production compatibility (works on localhost too)
        const API_URL = '';

        async function authFetch(endpoint, options = {}) {
            const token = localStorage.getItem('access_token');
            if (!token) return handleLogout();

            const headers = options.headers || {};
            headers['Authorization'] = `Bearer ${token}`;

            const config = {
                ...options,
                headers: headers
            };

            const res = await fetch(`${API_URL}${endpoint}`, config);

            if (res.status === 401) {
                handleLogout();
                return null;
            }
            return res;
        }

        async function fetchHistory() {
            const res = await authFetch('/api/history');
            if (!res) return [];
            return await res.json();
        }

        async function fetchStats() {
            const res = await authFetch('/api/stats');
            if (!res) return null;
            return await res.json();
        }

        let currentMarkId = null;
        let currentFilterType = 'all';
        let selectedGenre = null;

        function openMarkWatchedModal(id) {
            currentMarkId = id;
            document.getElementById('status-date').valueAsDate = new Date();
            document.getElementById('mark-watched-modal').classList.remove('hidden');
        }

        function closeMarkWatchedModal() {
            document.getElementById('mark-watched-modal').classList.add('hidden');
            currentMarkId = null;
        }

        async function confirmMarkWatched() {
            if (!currentMarkId) return;
            const dateVal = document.getElementById('status-date').value;
            const date = dateVal ? new Date(dateVal).toISOString() : null;
            await markWatchedApi(currentMarkId, date);
            closeMarkWatchedModal();
        }

        async function skipDateMarkWatched() {
            if (!currentMarkId) return;
            await markWatchedApi(currentMarkId, null); // Backend defaults to Now
            closeMarkWatchedModal();
        }

        async function markWatchedApi(id, dateStr) {
            await authFetch(`/api/entry/${id}/status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'watched', watched_at: dateStr })
            });
            init(); // Refresh
        }

        // Manual Add Logic Update
        document.getElementById('add-status').addEventListener('change', (e) => {
            const dateContainer = document.getElementById('add-date-container');
            if (e.target.value === 'watched') {
                dateContainer.classList.remove('hidden');
                document.getElementById('add-date').valueAsDate = new Date();
            } else {
                dateContainer.classList.add('hidden');
            }
        });

        // Search Logic
        let searchTimeout;
        function debounceSearchv2() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(doSearchv2, 500);
        }

        async function doSearchv2() {
            const query = document.getElementById('add-search').value;
            if (query.length < 2) {
                document.getElementById('add-search-results').classList.add('hidden');
                return;
            }
            // Use existing search endpoint but logic is different. Wait, current endpoint /api/social/search is for USERS.
            // I need a TMDB search endpoint. Let's assume one exists or mock it with a client call? 
            // NO, CORS issues. AND API Key exposure.
            // I MUST ADD A BACKEND ENDPOINT FOR SEARCH.
            // For now, I'll update the JS and then go fix Backend.

            const res = await authFetch(`/api/tmdb/search?q=${encodeURIComponent(query)}`);
            if (!res) return;
            const data = await res.json();

            const dropdown = document.getElementById('add-search-results');
            dropdown.innerHTML = '';

            if (data.length > 0) {
                dropdown.classList.remove('hidden');
                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'p-3 hover:bg-white/10 cursor-pointer flex gap-3 items-center border-b border-white/5';
                    const img = item.poster_path ? `https://image.tmdb.org/t/p/w92${item.poster_path}` : 'https://via.placeholder.com/40x60';
                    div.innerHTML = `
                        <img src="${img}" class="w-8 h-12 object-cover rounded">
                        <div>
                            <div class="font-bold text-sm text-white">${item.title || item.name}</div>
                            <div class="text-xs text-slate-400">${item.media_type.toUpperCase()} ‚Ä¢ ${(item.release_date || item.first_air_date || '').substring(0, 4)}</div>
                        </div>
                        <button onclick="event.stopPropagation(); quickBlock(${item.id}, '${item.media_type}', '${(item.title || item.name).replace(/'/g, "\\'")}')" class="ml-auto p-2 hover:bg-red-500/20 rounded-full text-slate-500 hover:text-red-400 transition-colors" title="Block this title">
                            <i data-lucide="ban" class="w-4 h-4"></i>
                        </button>
                    `;
                    div.onclick = () => selectItem(item);
                    dropdown.appendChild(div);
                });
                if (window.lucide) lucide.createIcons();

            } else {
                dropdown.classList.add('hidden');
            }
        }

        function selectItem(item) {
            document.getElementById('selected-tmdb-id').value = item.id;
            document.getElementById('selected-media-type').value = item.media_type;
            document.getElementById('selected-title').textContent = item.title || item.name;
            document.getElementById('selected-poster').src = item.poster_path ? `https://image.tmdb.org/t/p/w92${item.poster_path}` : '';
            document.getElementById('selected-meta').textContent = `${item.media_type.toUpperCase()} ‚Ä¢ ${(item.release_date || item.first_air_date || '').substring(0, 4)}`;

            document.getElementById('selected-preview').classList.remove('hidden');
            document.getElementById('add-search').value = '';
            document.getElementById('add-search-results').classList.add('hidden');
        }



        async function quickBlock(id, type, title) {
            if (!confirm(`Block "${title}"? It won't be recommended to you.`)) return;

            // Direct API call
            const payload = {
                title: title,
                media_type: type,
                status: 'blocked',
                tmdb_id: id,
                rating: 0
            };

            try {
                const res = await authFetch('/api/log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res && res.ok) {
                    alert("Blocked successfully.");
                    document.getElementById('add-search').value = '';
                    document.getElementById('add-search-results').classList.add('hidden');
                    loadMyPlaylists(); // Refresh lists to show blocked count if needed
                }
            } catch (e) {
                console.error(e);
                alert("Failed to block.");
            }
        }

        function clearSelection() {
            document.getElementById('selected-tmdb-id').value = '';
            document.getElementById('selected-preview').classList.add('hidden');
        }

        async function submitManualAdd() {
            const tmdbId = document.getElementById('selected-tmdb-id').value;
            const type = document.getElementById('selected-media-type').value;
            const status = document.getElementById('add-status').value;
            const dateVal = document.getElementById('add-date').value;

            if (!tmdbId) return alert("Please search and select a movie/show first!");

            // Reuse Log Logic but with proper payload
            // Wait, previous /api/log utilized a server-side search by title. 
            // I should update /api/log to accept ID directly for precision.
            // Or just stick to title if I don't change backend API.
            // BETTER: Use /api/log but pass 'id' in payload if supported? 
            // Current Backend: search_tmdb(request.title, request.media_type) -> First result.
            // This is imprecise. I should Update Backend to accept `tmdb_id` optional override.

            const payload = {
                title: document.getElementById('selected-title').textContent, // Fallback
                media_type: type,
                status: status,
                tmdb_id: parseInt(tmdbId), // New field I need to handle in Backend
                rating: parseInt(document.getElementById('manual-rating')?.value || '0')
            };

            if (status === 'watched' && dateVal) {
                payload.watched_at = new Date(dateVal).toISOString();
            }

            const res = await authFetch('/api/log', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res && res.ok) {
                closeAddModal();
                clearSelection();
                const data = await res.json();
                alert(data.note || `Added ${data.saved}`);
                init();
            } else {
                alert("Failed to add");
            }
        }

        async function deleteEntry(id) {
            if (!confirm("Are you sure you want to delete this item?")) return;
            await authFetch(`/api/entry/${id}`, {
                method: 'DELETE'
            });
            init(); // Refresh
        }

        async function unblockItem(id) {
            if (!confirm("Remove this item from your blocked list?")) return;
            await authFetch(`/api/entry/${id}`, {
                method: 'DELETE'
            });
            init(); // Refresh
        }

        async function fetchRecommendations() {
            const res = await authFetch('/api/recommendations');
            if (!res) return [];
            return await res.json();
        }

        async function loadRecs() {
            const container = document.getElementById('recommendations-list');
            // Optimistic / Loading UI
            container.innerHTML = '<div class="col-span-full text-center py-10 text-slate-500 animate-pulse">Consulting the oracle...</div>';

            const recs = await fetchRecommendations();

            if (recs.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-10 text-slate-500">No recommendations found. Watch more stuff!</div>';
                return;
            }

            container.innerHTML = recs.map(i => renderRecCard(i)).join('');
            if (window.lucide) lucide.createIcons();
        }

        function handleLogout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_info');
            document.cookie = "access_token=; path=/; max-age=0";
            window.location.href = '/login';
        }

        function renderStarDisplay(rating) {
            if (!rating) return '';
            let stars = '';
            for (let i = 0; i < 5; i++) {
                if (i < rating) stars += '<i data-lucide="star" class="w-3 h-3 text-yellow-400 fill-yellow-400"></i>';
                else stars += '<i data-lucide="star" class="w-3 h-3 text-slate-600"></i>';
            }
            return `<div class="flex gap-0.5">${stars}</div>`;
        }

        function renderWatchProviders(item) {
            if (!item.watch_providers) return '';

            try {
                const providers = JSON.parse(item.watch_providers);
                // Get user's country from profile (default to US if not set)
                const userCountry = currentUser.country || 'US';
                const countryCode = userCountry === 'Nigeria' ? 'NG' : userCountry === 'United States' ? 'US' : 'US';

                const countryData = providers[countryCode];
                if (!countryData || !countryData.flatrate) return '';

                // Show first 3 streaming services
                const services = countryData.flatrate.slice(0, 3);
                if (services.length === 0) return '';

                return `
                    <div class="flex gap-1 mt-2 flex-wrap">
                        ${services.map(s => `
                            <div class="bg-white/10 px-2 py-0.5 rounded text-[9px] font-bold text-white/80 flex items-center gap-1" title="${s.provider_name}">
                                ${s.logo_path ? `<img src="https://image.tmdb.org/t/p/w45${s.logo_path}" class="w-3 h-3 rounded">` : ''}
                                <span class="truncate max-w-[60px]">${s.provider_name}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (e) {
                console.error('Error parsing watch providers:', e);
                return '';
            }
        }

        function renderCard(item, isWatchlist = false, isBlockedView = false) {
            const poster = item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : 'https://via.placeholder.com/500x750?text=No+Image';
            const rating = item.rating || 'NR';
            const typeLabel = item.media_type === 'movie' ? 'Movie' : 'TV';
            const googleUrl = `https://www.google.com/search?q=${encodeURIComponent(item.title + ' ' + (item.media_type === 'tv' ? 'tv series' : 'movie'))}`;

            // Generate Genre Pills (Top 2)
            let genreHTML = '';
            if (item.genres) {
                let gList = item.genres;
                if (typeof gList === 'string') {
                    if (gList.startsWith('[')) {
                        try { gList = JSON.parse(gList); } catch (e) { gList = []; }
                    } else {
                        gList = gList.split(',').map(s => s.trim());
                    }
                }
                if (Array.isArray(gList)) {
                    genreHTML = gList.slice(0, 2).map(g =>
                        `<span class="text-[9px] font-bold bg-black/50 px-2 py-0.5 rounded backdrop-blur-sm border border-white/10 text-slate-300">
                            ${typeof g === 'object' ? g.name : g}
                          </span>`
                    ).join('');
                }
            }

            // Logic for main action button
            let btnAction = '';
            if (isBlockedView || item.status === 'blocked') {
                btnAction = `<button onclick="unblockItem(${item.tmdb_id})" class="flex-1 bg-green-600 hover:bg-green-500 text-white py-2 rounded-lg text-xs font-bold transition-colors uppercase tracking-wide">Unblock</button>`;
            } else {
                btnAction = `
                    <button onclick="openAddToPlaylistModal(${item.tmdb_id}, '${item.title.replace(/'/g, "\\'")}', '${item.media_type}', '${item.poster_path || ''}')" class="flex-1 bg-white/10 hover:bg-white/20 backdrop-blur-md text-white py-2 rounded-lg text-xs font-bold transition-colors flex items-center justify-center gap-1">
                        <i data-lucide="folder-plus" class="w-3 h-3"></i> Add
                    </button>
                    ${isWatchlist ?
                        `<button onclick="openMarkWatchedModal(${item.tmdb_id}, '${item.title.replace(/'/g, "&apos;")}', '${item.media_type}')" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white py-2 rounded-lg text-xs font-bold transition-colors">Watched</button>` :
                        `<button onclick="submitRewatch(${item.tmdb_id}, '${item.title.replace(/'/g, "&apos;")}')" class="flex-1 bg-white/10 hover:bg-white/20 text-white py-2 rounded-lg text-xs font-bold transition-colors flex items-center justify-center gap-1"><i data-lucide="rotate-ccw" class="w-3 h-3"></i> Rewatch</button>`
                    }
                `;
            }

            return `
            <div class="glass rounded-xl overflow-hidden relative group card-hover animate-in">
                <div class="relative aspect-[2/3]">
                    <a href="${googleUrl}" target="_blank" rel="noopener noreferrer" class="block w-full h-full cursor-pointer">
                        <img src="${poster}" alt="${item.title}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105">
                    </a>
                    
                    <!-- Delete Button Overlay (always visible on small screens, hover on large) -->
                    <button onclick="event.preventDefault(); deleteEntry(${item.tmdb_id})" class="absolute top-2 left-2 bg-red-500/80 hover:bg-red-600 text-white p-2 rounded-full opacity-100 lg:opacity-0 group-hover:opacity-100 transition-all backdrop-blur-sm z-30 shadow-lg" title="Delete Permanentally">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>

                    <div class="absolute top-2 right-2 bg-black/60 px-2 py-1 rounded text-[10px] backdrop-blur-sm font-bold border border-white/10 text-white">${item.year || 'N/A'}</div>

                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-4">
                        <div class="flex gap-2 mb-3">
                            ${btnAction}
                        </div>
                        ${!isWatchlist && item.media_type === 'tv' ?
                    `<button onclick="openProgressModal(${item.tmdb_id}, '${item.title.replace(/'/g, "&apos;")}', '${item.seasons_watched || ''}', ${item.episode_progress || 0}, '${item.watched_episodes ? item.watched_episodes.replace(/'/g, "\\'") : "[]"}')" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 py-2 rounded-lg text-xs font-bold transition-colors border border-slate-600">Update Progress</button>` : ''
                }
                    </div>
                </div>
                <div class="p-4">
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="font-bold text-white text-sm truncate pr-2" title="${item.title}">${item.title}</h3>
                        <span class="text-[10px] bg-indigo-500/20 text-indigo-300 px-1.5 py-0.5 rounded uppercase font-bold tracking-wider">${typeLabel}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-yellow-400 text-xs">‚òÖ ${rating}</span>
                        <div class="flex gap-1">${genreHTML}</div>
                    </div>
                </div>
            </div>
            `;
        }
        function renderRecCard(item) {
            const posterUrl = item.poster_path
                ? `https://image.tmdb.org/t/p/w200${item.poster_path}`
                : 'https://via.placeholder.com/200x300';

            return `
                <div class="flex gap-4 items-center p-3 hover:bg-slate-800/50 rounded-lg transition-colors cursor-pointer" onclick="window.open('https://google.com/search?q=${item.title}', '_blank')">
                    <img src="${posterUrl}" class="w-12 h-18 rounded object-cover">
                    <div>
                        <h4 class="font-medium text-white">${item.title || item.name}</h4>
                        <p class="text-xs text-slate-400">Match score: ${Math.round(item.vote_average * 10)}%</p>
                    </div>
                </div>
            `;
        }

        function renderFeedItem(item) {
            const commentsHtml = item.comments.map(c => `
                <div class="text-xs mt-1"><span class="font-bold text-slate-300">${c.user}:</span> <span class="text-slate-400">${c.content}</span></div>
            `).join('');

            return `
                <div id="feed-item-${item.id}" class="glass rounded-xl p-4 flex gap-4 items-start animate-swing group/item">
                    <div class="relative flex-shrink-0 cursor-pointer" onclick="openUserProfile(${item.user_id})">
                        <img src="${item.poster_path ? 'https://image.tmdb.org/t/p/w200' + item.poster_path : 'https://via.placeholder.com/100'}" 
                             class="w-16 h-24 object-cover rounded shadow-lg">
                        <div class="absolute -bottom-2 -right-2 w-8 h-8 rounded-full border-2 border-slate-900 overflow-hidden bg-slate-800 hover:scale-110 transition-transform">
                             <img src="${item.user_picture}" class="w-full h-full object-cover">
                        </div>
                    </div>
                    <div class="flex-1 min-w-0 pt-1">
                        <div class="flex justify-between items-start">
                             <div>
                                <p class="text-sm text-slate-400 mb-0.5"><span class="font-bold text-white">${item.user_name}</span> watched</p>
                                <h4 class="font-bold text-lg text-white leading-tight truncate px-0">${item.title}</h4>
                             </div>
                             <span class="text-xs text-slate-500 whitespace-nowrap">${new Date(item.date).toLocaleDateString()}</span>
                        </div>
                        
                        <!-- Interactions Panel -->
                        <div class="mt-3 flex gap-2 items-center">
                            <button onclick="toggleLike(${item.id})" class="flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium transition-colors ${item.is_liked ? 'bg-pink-500/20 text-pink-400' : 'bg-white/5 hover:bg-white/10 text-slate-400'}">
                                <i data-lucide="heart" class="w-3 h-3 ${item.is_liked ? 'fill-current' : ''}"></i> ${item.like_count || 0}
                            </button>
                            <button onclick="toggleRoastBox(${item.id})" class="flex items-center gap-1 px-3 py-1 bg-white/5 hover:bg-white/10 text-slate-400 rounded-full text-xs font-medium transition-colors">
                                <i data-lucide="flame" class="w-3 h-3"></i> Roast
                            </button>
                        </div>

                        <!-- Comments Section -->
                        <div class="mt-3 space-y-2 ${item.comments.length > 0 ? '' : 'hidden'}">
                            ${commentsHtml}
                        </div>
                        
                        <!-- Roast Input (Hidden by default) -->
                        <div id="roast-box-${item.id}" class="hidden mt-3 flex gap-2">
                             <input type="text" id="roast-input-${item.id}" placeholder="Spill the tea..." class="flex-1 bg-slate-800 border-none rounded-lg py-1 px-3 text-xs text-white">
                             <button onclick="startVoiceComment(${item.id})" class="text-xs bg-slate-700 hover:bg-slate-600 text-white p-2 rounded-lg transition-colors" title="Voice comment">
                                 <i data-lucide="mic" class="w-4 h-4"></i>
                             </button>
                             <button onclick="submitRoast(${item.id})" class="text-xs bg-indigo-600 text-white px-3 rounded-lg">Send</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Social Actions ---
        async function toggleLike(id) {
            await authFetch(`/api/social/like/${id}`, { method: 'POST' });
            loadFeed(); // Refresh to show update
        }

        function toggleRoastBox(id) {
            document.getElementById(`roast-box-${id}`).classList.toggle('hidden');
        }

        async function submitRoast(id) {
            const input = document.getElementById(`roast-input-${id}`);
            const content = input.value;
            if (!content) return;

            await authFetch(`/api/social/comment/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });
            input.value = '';
            loadFeed();
        }

        function startVoiceComment(id) {
            const input = document.getElementById(`roast-input-${id}`);

            // Check for browser support
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert("Voice input not supported in this browser. Try Chrome or Safari.");
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            // Visual feedback
            input.placeholder = "üé§ Listening...";
            input.classList.add('ring-2', 'ring-red-500');

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                input.value = transcript;
                input.placeholder = "Spill the tea...";
                input.classList.remove('ring-2', 'ring-red-500');
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                input.placeholder = "Spill the tea...";
                input.classList.remove('ring-2', 'ring-red-500');
                if (event.error !== 'no-speech') {
                    alert(`Voice error: ${event.error}`);
                }
            };

            recognition.onend = () => {
                input.placeholder = "Spill the tea...";
                input.classList.remove('ring-2', 'ring-red-500');
            };

            recognition.start();
        }

        // --- Profile ---
        let currentUser = {}; // Store current user info

        async function loadUser() {
            try {
                const res = await authFetch('/api/users/me');
                if (res.ok) {
                    const user = await res.json();
                    currentUser = user;
                    localStorage.setItem('user_info', JSON.stringify(user));
                    updateProfileUI(user);
                }
            } catch (e) {
                console.error("Failed to load user", e);
            }
        }

        function openEditProfile() {
            document.getElementById('edit-profile-modal').classList.remove('hidden');
            document.getElementById('edit-bio').value = currentUser.bio || '';
            document.getElementById('edit-pic').value = currentUser.picture || '';
            document.getElementById('edit-name').value = currentUser.name || '';
            document.getElementById('edit-city').value = currentUser.city || '';
            document.getElementById('edit-country').value = currentUser.country || '';
            document.getElementById('edit-is-public').checked = currentUser.is_public !== false; // Default to true
        }

        async function submitProfileEdit() {
            const bio = document.getElementById('edit-bio').value;
            let pic = document.getElementById('edit-pic').value;
            const name = document.getElementById('edit-name').value;
            const city = document.getElementById('edit-city').value;
            const country = document.getElementById('edit-country').value;
            const fileInput = document.getElementById('edit-pic-file');

            // Upload File if selected
            if (fileInput.files.length > 0) {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);

                // Use raw fetch for upload to let browser handle boundary
                const token = localStorage.getItem('access_token');
                try {
                    const uploadRes = await fetch(`${API_URL}/api/users/upload-avatar`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });

                    if (uploadRes.ok) {
                        const data = await uploadRes.json();
                        pic = data.url;
                    } else {
                        alert("Image upload failed");
                        return;
                    }
                } catch (e) {
                    console.error("Upload Error", e);
                    alert("Upload error");
                    return;
                }
            }

            const res = await authFetch('/api/users/me', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    bio: bio,
                    picture: pic,
                    name: name,
                    city: city,
                    country: country,
                    is_public: document.getElementById('edit-is-public').checked
                })
            });

            if (res.ok) {
                const data = await res.json();
                // Update Local Storage
                const info = JSON.parse(localStorage.getItem('user_info') || '{}');
                Object.assign(info, data); // Merge all fields
                localStorage.setItem('user_info', JSON.stringify(info));

                // Update UI
                updateProfileUI(info);
                document.getElementById('edit-profile-modal').classList.add('hidden');
            } else {
                alert("Failed to update profile");
            }
        }

        // --- Level Logic (15 Tiers) ---
        function getLevelTitle(level, watchedCount = 0) {
            // Special Immortal Rank
            if (watchedCount > 1000) return "üåå Immortal";

            if (level <= 3) return "Novice";
            if (level <= 6) return "Casual Viewer";
            if (level <= 9) return "Popcorn Eater";
            if (level <= 14) return "Weekend Watcher";
            if (level <= 19) return "Series Binger";
            if (level <= 29) return "Film Student";
            if (level <= 39) return "Critic";
            if (level <= 49) return "Taste Maker";
            if (level <= 59) return "Screenwriter";
            if (level <= 69) return "Director";
            if (level <= 79) return "Producer";
            if (level <= 89) return "Auteur";
            if (level <= 99) return "Visionary";
            if (level <= 149) return "Legend";
            return "Cinephile God";
        }

        function updateProfileUI(user) {
            console.log("Updating Profile UI:", user);
            if (!user) return;
            currentUser = user; // Update global current user
            document.getElementById('my-profile-pic').src = user.picture;
            document.getElementById('my-profile-name').innerText = user.name;
            document.getElementById('my-profile-bio').innerText = user.bio || "No bio yet.";

            // Gamification UI
            const levelTitle = getLevelTitle(user.level, (user.xp / 10)); // Approx watched count from xp? No, we need actual count. 
            // We don't have total watched count in user object yet? 
            // /api/users/me returns xp, level, current_streak, badges.
            // Let's rely on Level for now, or fetch stats to get count. 
            // For now, use Level. 

            // Inject Level/XP
            // Check if containers exist, if not create them
            let statsContainer = document.getElementById('profile-stats-container');
            if (!statsContainer) {
                statsContainer = document.createElement('div');
                statsContainer.id = 'profile-stats-container';
                statsContainer.className = 'mt-4 pt-4 border-t border-white/10 text-left space-y-3';
                document.getElementById('my-profile-bio').after(statsContainer);
            }

            // Calculate XP Progress (rough estimate for visual)
            // Level = floor(sqrt(XP)/20) + 1  => XP = ((Level-1)*20)^2
            // Next Level XP = ((Level)*20)^2
            const currentLevelMinXp = Math.pow((user.level - 1) * 20, 2);
            const nextLevelXp = Math.pow(user.level * 20, 2);
            const progress = Math.min(100, Math.max(0, ((user.xp - currentLevelMinXp) / (nextLevelXp - currentLevelMinXp)) * 100)) || 0;

            statsContainer.innerHTML = `
                <div class="flex justify-between items-end">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Lvl ${user.level}</span>
                    <span class="text-xs font-bold text-indigo-400">${levelTitle}</span>
                </div>
                <div class="w-full h-1.5 bg-slate-800 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500" style="width: ${progress}%"></div>
                </div>
                <div class="flex justify-between items-center text-xs mt-1">
                    <span class="text-slate-500">${user.xp} XP</span>
                    <span class="flex items-center gap-1 text-orange-400 font-bold">
                        <i data-lucide="flame" class="w-3 h-3"></i> ${user.current_streak} Day Streak
                    </span>
                </div>
                
                <!-- Badges -->
                <div class="flex gap-2 flex-wrap mt-3">
                    ${(user.badges || []).map(b => `
                        <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-sm border border-white/10" title="${b.name}: ${b.description}">
                            ${b.icon.startsWith('http') || b.icon.length > 20 ? `<i data-lucide="${b.icon}" class="w-4 h-4 text-yellow-400"></i>` : b.icon}
                        </div>
                    `).join('')}
                </div>
            `;

            if (window.lucide) lucide.createIcons();

            // Re-init Lucide icons if library loaded
            if (window.lucide) lucide.createIcons();
        }

        async function exportData(type, format = 'csv') {
            const token = localStorage.getItem('access_token');
            if (!token) return;

            const link = document.createElement('a');

            if (format === 'html') {
                // Open public list view in new tab
                // Need current user ID. We have it in uInfo
                const uInfo = JSON.parse(localStorage.getItem('user_info'));
                if (uInfo && uInfo.id) {
                    // Using window.location.origin to ensure correct base URL (http vs https)
                    window.open(`${window.location.origin}/u/${uInfo.id}/${type}`, '_blank');
                } else {
                    alert("Could not identify user for public link.");
                }
                return;
            }

            // CSV Download
            link.href = `${API_URL}/api/export?type=${type}&format=csv`;
            // link.download = 'watched_export.csv'; // Backend sets header
            try {
                // Fetch blob to force download or just click link?
                // Direct link click is simpler if auth cookie is present (it is)
                // But if strict auth header needed, fetch is safer
                const res = await authFetch(`${API_URL}/api/export?type=${type}&format=csv`, {
                    method: 'GET'
                });

                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `watched_${type}_export.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    alert("Export downloaded!");
                } else {
                    alert("Export failed");
                }
            } catch (e) {
                console.error("Export Error", e);
                alert("Export error occurred");
            }
        }

        // --- Notifications ---
        async function pollNotifications() {
            const res = await authFetch('/api/notifications');
            if (res && res.ok) {
                const notifs = await res.json();
                const btn = document.getElementById('notif-badge');
                if (notifs.length > 0) {
                    btn.classList.remove('hidden');
                    const list = document.getElementById('notif-list');
                    list.innerHTML = notifs.map(n => `
                        <div onclick="handleNotificationClick(${n.ref_id}, '${n.type}', ${n.id})" class="px-2 py-2 hover:bg-slate-800 rounded text-xs cursor-pointer transition-colors border-l-2 border-transparent hover:border-indigo-500">
                            <p class="text-white">${n.message}</p>
                            <span class="text-slate-500 text-[10px]">${new Date(n.created_at).toLocaleTimeString()}</span>
                        </div>
                    `).join('');
                } else {
                    btn.classList.add('hidden');
                }
            }
        }

        async function pollInbox() {
            const res = await authFetch('/api/inbox');
            if (res && res.ok) {
                const messages = await res.json();
                const unread = messages.filter(m => !m.read).length;
                const badge = document.getElementById('inbox-badge');

                if (unread > 0) {
                    badge.textContent = unread > 9 ? '9+' : unread;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        async function clearNotifications() {
            await authFetch('/api/notifications/clear', { method: 'POST' });
            document.getElementById('notif-badge').classList.add('hidden');
            document.getElementById('notif-list').innerHTML = '<div class="text-center text-slate-600 text-xs py-4">All clear</div>';
        }

        async function handleNotificationClick(refId, type, notifId) {
            // 1. Mark as read (optional specific endpoint, or just clear all? User said clear all clears list. Specific click should probably keep it or mark just one? API only has clear all. Leaving it for now, or just ignore.)

            // 2. Switch to Social
            if (type === 'like' || type === 'comment') {
                switchTab('social');
                // Check if feed item exists
                const existingItem = document.getElementById(`feed-item-${refId}`);
                if (existingItem) {
                    existingItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    existingItem.classList.add('ring-2', 'ring-indigo-500');
                    setTimeout(() => existingItem.classList.remove('ring-2', 'ring-indigo-500'), 2000);
                    // If comment, open roast box
                    if (type === 'comment' || type === 'like') {
                        toggleRoastBox(refId);
                        document.getElementById(`roast-input-${refId}`).focus();
                    }
                } else {
                    // Fetch Item from API
                    try {
                        const res = await authFetch(`/api/social/feed/${refId}`);
                        if (res.ok) {
                            const item = await res.json();
                            // Prepend to feed
                            const feedContainer = document.getElementById('social-feed-list');
                            const temp = document.createElement('div');
                            temp.innerHTML = renderFeedItem(item);
                            const newNode = temp.firstElementChild;

                            feedContainer.insertBefore(newNode, feedContainer.firstChild);

                            // Now scroll
                            newNode.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            newNode.classList.add('ring-2', 'ring-indigo-500');
                            setTimeout(() => newNode.classList.remove('ring-2', 'ring-indigo-500'), 2000);
                            if (type === 'comment' || type === 'like') {
                                toggleRoastBox(refId);
                                document.getElementById(`roast-input-${refId}`).focus();
                            }
                        }
                    } catch (e) {
                        console.error("Failed to fetch notification item", e);
                    }
                }
            }
        }

        // Polling
        setInterval(pollNotifications, 30000); // Every 30s
        setTimeout(pollNotifications, 2000); // Initial check
        setInterval(pollInbox, 30000); // Every 30s
        setTimeout(pollInbox, 2000); // Initial check

        // Init Profile
        const uInfo = JSON.parse(localStorage.getItem('user_info'));
        if (uInfo) {
            updateProfileUI(uInfo);
        }
        loadUser(); // Fetch fresh data

        // Date Gate for Wrapped Season (Nov 29 - Dec 31)
        const now = new Date();
        const month = now.getMonth(); // 0-11
        const day = now.getDate();
        const isWrappedSeason = (month === 10 && day >= 29) || (month === 11); // Nov 29+ or all of Dec

        if (isWrappedSeason) {
            // Hide Rankings, show Wrapped
            document.getElementById('tab-leaderboard').classList.add('hidden');
        } else {
            // Hide Wrapped, show Rankings
            document.getElementById('tab-report').classList.add('hidden');
            document.getElementById('wrapped-divider').classList.add('hidden');
        }

        async function loadUpcoming() {
            const container = document.getElementById('coming-soon-list');
            if (!container) return;
            try {
                const res = await authFetch('/api/tmdb/upcoming');
                if (res && res.ok) {
                    const items = await res.json();
                    if (items.length === 0) {
                        container.innerHTML = '<div class="text-slate-500 italic p-4 text-sm shrink-0">Nothing on the radar...</div>';
                        return;
                    }
                    container.innerHTML = items.map(item => {
                        const img = item.poster_path ? `https://image.tmdb.org/t/p/w300${item.poster_path}` : 'https://via.placeholder.com/200x300';
                        const type = item.media_type === 'movie' ? 'Movie' : 'TV';
                        const date = item.release_date || item.first_air_date || 'Soon';
                        return `
                           <div class="shrink-0 w-32 md:w-40 snap-start bg-slate-900/50 rounded-xl overflow-hidden relative group cursor-pointer border border-white/5 hover:border-indigo-500/50 transition-colors" onclick="window.open('https://google.com/search?q=${item.title || item.name} ${type}', '_blank')">
                               <div class="aspect-[2/3] relative">
                                   <img src="${img}" class="w-full h-full object-cover">
                                   <div class="absolute top-2 right-2 px-1.5 py-0.5 rounded bg-black/60 backdrop-blur text-[9px] font-bold uppercase tracking-wider">${type}</div>
                               </div>
                               <div class="p-2 md:p-3">
                                   <h4 class="font-bold text-xs md:text-sm text-white truncate mb-0.5" title="${item.title || item.name}">${item.title || item.name}</h4>
                                   <p class="text-[10px] text-slate-400">${date}</p>
                               </div>
                           </div>
                       `;
                    }).join('');
                    if (window.lucide) lucide.createIcons();
                }
            } catch (e) {
                console.error("Upcoming Error", e);
            }
        }

        // --- PROFILE LOGIC ---
        async function loadProfile() {
            try {
                const res = await authFetch('/api/users/me');
                if (res && res.ok) {
                    const user = await res.json();
                    // Update UI
                    const pic = document.getElementById('my-profile-pic');
                    const name = document.getElementById('my-profile-name');
                    const bio = document.getElementById('my-profile-bio');

                    if (pic) pic.src = user.picture || 'https://via.placeholder.com/150';
                    if (name) name.innerText = user.name || 'User';
                    if (bio) bio.innerText = user.bio || 'No bio yet.';

                    // Store globally if needed
                    window.currentUser = user;
                }
            } catch (e) {
                console.error("Profile load failed", e);
            }
        }

        async function init() {
            // Check Auth
            // Check Auth
            let token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            await loadProfile();
            loadUpcoming(); // <--- Added here
            try {
                const [history, stats] = await Promise.all([fetchHistory(), fetchStats()]);
                console.log("DEBUG STATS:", stats);
                // alert("Debug: " + JSON.stringify(stats?.counts || "No Counts")); 

                // Safety Check
                if (!stats || !stats.counts) {
                    console.warn("Stats data missing or incomplete.", stats);
                    alert("Stats Error: Data missing from backend.");
                    // Set defaults to prevent crash
                    if (stats) {
                        stats.counts = stats.counts || { watchlist: 0, watched: 0, movies: 0, series: 0 };
                        stats.split_runtime = stats.split_runtime || { movies: 0, series: 0 };
                        stats.avg_hours_to_watch = stats.avg_hours_to_watch || 0;
                        stats.top_genres = stats.top_genres || [];
                        stats.top_studios = stats.top_studios || [];
                        stats.top_cast = stats.top_cast || [];
                        stats.monthly_activity = stats.monthly_activity || [];
                        stats.decade_distribution = stats.decade_distribution || [];
                    } else {
                        return; // Retrying...
                    }
                }

                // 1. Update Stats
                document.getElementById('stat-watchlist').innerText = stats.counts.watchlist;
                document.getElementById('stat-watched').innerText = stats.counts.watched;

                if (window.lucide) lucide.createIcons();

                // Format hours nicer
                const totalHours = Math.round((stats.total_runtime_minutes || 0) / 60);
                const movieHours = Math.round((stats.split_runtime.movies || 0) / 60);
                const seriesHours = Math.round((stats.split_runtime.series || 0) / 60);

                document.getElementById('stat-hours').innerText = totalHours + 'h';
                document.getElementById('stat-hours-breakdown').innerHTML = `
                <span class="text-indigo-300">${movieHours}h Movies</span> ‚Ä¢ 
                <span class="text-purple-300">${seriesHours}h Series</span>
            `;

                document.getElementById('stat-velocity').innerText = stats.avg_hours_to_watch + 'h';

                // --- DEEP DIVE CARDS ---
                if (stats.counts.completion_rate !== undefined) {
                    document.getElementById('stat-completion').innerText = stats.counts.completion_rate + '%';
                    document.getElementById('stat-rating').innerText = stats.counts.avg_rating;
                    document.getElementById('stat-perfect').innerText = stats.counts.perfect_scores;
                }

                // 2. Grids
                // Fix: Match backend stats logic (anything not 'watched' is watchlist)
                const watchlist = history.filter(i => i.status !== 'watched' && i.status !== 'blocked');
                const watched = history.filter(i => i.status === 'watched');

                // Store global data for filters (include all items for blocked filter to work)
                window.watchlistData = watchlist;
                window.historyData = history; // Store ALL items so blocked filter can access them

                // Initial Render (using filters)
                renderGenrePills();
                renderGridWithFilters();

                // Old direct render - REMOVED
                // document.getElementById('watchlist-grid').innerHTML = watchlist.map(i => renderCard(i, true)).join('');
                // document.getElementById('history-grid').innerHTML = watched.map(i => renderCard(i, false)).join('');

                // 3. Charts

                // Helper to safe destroy
                const destroyChart = (id) => {
                    const chartStatus = Chart.getChart(id);
                    if (chartStatus != undefined) {
                        chartStatus.destroy();
                    }
                };

                // A. Genres (Doughnut)
                if (stats.top_genres.length > 0) {
                    destroyChart('genreChart');
                    new Chart(document.getElementById('genreChart'), {
                        type: 'doughnut',
                        data: {
                            labels: stats.top_genres.map(g => g[0]),
                            datasets: [{
                                data: stats.top_genres.map(g => g[1]),
                                backgroundColor: ['#818cf8', '#c084fc', '#34d399', '#f472b6', '#60a5fa'],
                                borderWidth: 0
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#94a3b8', boxWidth: 12 } } } }
                    });
                }

                // B. Format Split (Pie)
                destroyChart('formatChart');
                new Chart(document.getElementById('formatChart'), {
                    type: 'pie',
                    data: {
                        labels: ['Movies', 'Series'],
                        datasets: [{
                            data: [stats.counts.movies, stats.counts.series],
                            backgroundColor: ['#6366f1', '#a855f7'],
                            borderWidth: 0
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#94a3b8', boxWidth: 12 } } } }
                });

                // C. Activity (Calendar Heatmap)
                // 3. Charts

                // C. Activity (Calendar Heatmap)
                // We don't use destroyChart('activityChart') because we replace the innerHTML entirely.
                // Target the stable container directly.
                const activityContainer = document.getElementById('activity-heatmap-container');

                // Clear canvas and reuse container
                if (activityContainer) {
                    activityContainer.innerHTML = '';
                }

                const heatmapMap = stats.daily_activity || {};
                const today = new Date();
                const currentYear = today.getFullYear();

                // Start: Jan 1 of Current Year
                const startDate = new Date(currentYear, 0, 1);
                // End: Dec 31 of Current Year
                const endDate = new Date(currentYear, 11, 31);

                // Generate dates
                let currentDate = new Date(startDate);
                let html = '<div class="flex gap-1 overflow-x-auto pb-2 custom-scrollbar">';

                // Group by Week
                let weeks = [];
                let currentWeek = [];

                // Pad start to Sunday
                const dayOfWeek = startDate.getDay(); // 0 = Sun
                for (let i = 0; i < dayOfWeek; i++) {
                    currentWeek.push(null); // Empty placeholder
                }

                while (currentDate <= endDate) {
                    // Safe Date Formatting (Local)
                    const year = currentDate.getFullYear();
                    const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                    const day = String(currentDate.getDate()).padStart(2, '0');
                    const dateStr = `${year}-${month}-${day}`;

                    const count = heatmapMap[dateStr] || 0;

                    currentWeek.push({ date: dateStr, count: count });

                    if (currentWeek.length === 7) {
                        weeks.push(currentWeek);
                        currentWeek = [];
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                if (currentWeek.length > 0) weeks.push(currentWeek); // Last partial week

                // Render
                html += weeks.map(week => {
                    return `<div class="flex flex-col gap-1">` +
                        week.map(day => {
                            if (!day) return `<div class="w-3 h-3 rounded-sm bg-transparent"></div>`;

                            let color = 'bg-white/5';
                            if (day.count > 0) color = 'bg-indigo-500 shadow-[0_0_10px_rgba(99,102,241,0.5)]';
                            if (day.count > 1) color = 'bg-indigo-400 shadow-[0_0_10px_rgba(129,140,248,0.6)]';
                            if (day.count > 3) color = 'bg-indigo-300 shadow-[0_0_10px_rgba(165,180,252,0.8)]';
                            if (day.count > 5) color = 'bg-white shadow-[0_0_15px_rgba(255,255,255,0.8)]';

                            return `<div class="w-3 h-3 rounded-sm ${color} hover:scale-125 transition-all cursor-pointer" title="${day.date}: ${day.count} items"></div>`;
                        }).join('') +
                        `</div>`;
                }).join('');

                html += '</div>';

                // Legend
                html += `
                <div class="flex items-center gap-2 mt-2 text-[10px] text-slate-500 justify-end">
                    <span>${currentYear}</span>
                    <span class="flex-1"></span>
                    <span>Less</span>
                    <div class="w-2 h-2 rounded-sm bg-white/5"></div>
                    <div class="w-2 h-2 rounded-sm bg-indigo-500"></div>
                    <div class="w-2 h-2 rounded-sm bg-indigo-300"></div>
                    <div class="w-2 h-2 rounded-sm bg-white"></div>
                    <span>More</span>
                </div>
                `;

                activityContainer.innerHTML = html;

                // D. Eras (Bar)
                destroyChart('eraChart');
                new Chart(document.getElementById('eraChart'), {
                    type: 'bar',
                    data: {
                        labels: stats.decade_distribution.map(d => d[0]),
                        datasets: [{
                            label: 'Items',
                            data: stats.decade_distribution.map(d => d[1]),
                            backgroundColor: '#fcd34d',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b', precision: 0 } },
                            x: { grid: { display: false }, ticks: { color: '#64748b' } }
                        }
                    }
                });

                // E. Runtime Distribution (Bar)
                if (stats.runtime_distribution) {
                    destroyChart('runtimeChart');
                    new Chart(document.getElementById('runtimeChart'), {
                        type: 'bar',
                        data: {
                            labels: Object.keys(stats.runtime_distribution),
                            datasets: [{
                                label: 'Items',
                                data: Object.values(stats.runtime_distribution),
                                backgroundColor: ['#34d399', '#facc15', '#f87171'],
                                borderRadius: 6,
                                barPercentage: 0.6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b', precision: 0 } },
                                x: { grid: { display: false }, ticks: { color: '#64748b' } }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error("Init Error:", error);
                alert("Critical Dashboard Error: " + error.message);
            }
        }

        // Global state for tracker
        let currentTracker = {
            tmdbId: null,
            seasons: [],
            watchedSeasons: new Set(),
            episodeProgress: {}, // { season_num: ep_count }
            activeSeason: 1
        };

        function closeProgressModal() {
            document.getElementById('edit-progress-modal').classList.add('hidden');
        }

        async function openProgressModal(tmdbId, title, seasonsStr, epsMap, watchedEpsStr) {
            currentTracker.tmdbId = tmdbId;
            document.getElementById('progress-modal-title').innerText = title;
            document.getElementById('edit-progress-modal').classList.remove('hidden');

            // Reset UI
            document.getElementById('progress-seasons-list').innerHTML = '<div class="animate-pulse flex space-x-4"><div class="flex-1 space-y-4 py-1"><div class="h-4 bg-slate-700 rounded w-3/4"></div></div></div>';
            document.getElementById('progress-episodes-list').innerHTML = '';

            // Parse existing progress
            currentTracker.watchedSeasons = new Set(seasonsStr && seasonsStr !== 'All' ? seasonsStr.split(',').map(s => parseInt(s.trim())) : []);

            // Parse granular episodes
            try {
                // If passed as object from JSON parse previously/string
                let eps = [];
                if (watchedEpsStr && typeof watchedEpsStr === 'string' && watchedEpsStr !== "[]") {
                    eps = JSON.parse(watchedEpsStr.replace(/'/g, '"')); // Handle potential single quotes
                } else if (Array.isArray(watchedEpsStr)) {
                    eps = watchedEpsStr;
                }
                currentTracker.activeWatchedEpisodes = new Set(eps);
            } catch (e) {
                console.error("Error parsing eps", e);
                currentTracker.activeWatchedEpisodes = new Set();
            }

            // Legacy handling: If episode_progress > 0 but tracked list empty, maybe populate default?
            // For now, respect the Set.


            // Fetch Show Details to get Seasons
            const res = await authFetch(`/api/tmdb/tv/${tmdbId}`);
            if (res && res.ok) {
                const data = await res.json();
                currentTracker.seasons = data.seasons || [];
                renderSeasonsList();

                // Auto-select first season or last watched
                if (currentTracker.seasons.length > 0) {
                    selectSeason(currentTracker.seasons[0].season_number);
                }
            }
        }

        function renderSeasonsList() {
            const list = document.getElementById('progress-seasons-list');
            list.innerHTML = currentTracker.seasons.map(s => {
                const isWatched = currentTracker.watchedSeasons.has(s.season_number);
                return `
                <button onclick="selectSeason(${s.season_number})"
                    class="w-full text-left px-4 py-3 rounded-xl transition-all flex items-center justify-between group ${currentTracker.activeSeason === s.season_number ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:bg-white/5 hover:text-white'}">
                    <span class="font-bold">Season ${s.season_number}</span>
                    ${isWatched ? '<span class="text-green-400 text-xs">‚úì</span>' : ''}
                </button>
                `;
            }).join('');
        }

        async function selectSeason(seasonNum) {
            currentTracker.activeSeason = seasonNum;
            renderSeasonsList(); // Update active state

            const list = document.getElementById('progress-episodes-list');
            list.innerHTML = '<div class="text-center text-slate-500 mt-10">Loading episodes...</div>';

            const res = await authFetch(`/api/tmdb/tv/${currentTracker.tmdbId}/season/${seasonNum}`);
            if (res && res.ok) {
                const data = await res.json();
                document.getElementById('progress-season-title').innerText = data.name || `Season ${seasonNum}`;
                document.getElementById('progress-season-meta').innerText = `${data.episodes?.length || 0} Episodes ‚Ä¢ ${data.air_date ? data.air_date.split('-')[0] : 'TBA'}`;

                renderEpisodesList(data.episodes || []);
            }
        }

        function renderEpisodesList(episodes) {
            const list = document.getElementById('progress-episodes-list');

            list.innerHTML = episodes.map(ep => {
                const epKey = `S${currentTracker.activeSeason}E${ep.episode_number}`;
                const isWatched = currentTracker.activeWatchedEpisodes.has(epKey) || currentTracker.watchedSeasons.has(currentTracker.activeSeason);

                return `
                <div onclick="toggleEpisode(${ep.episode_number})" class="flex gap-4 p-3 rounded-xl hover:bg-white/5 cursor-pointer group transition-colors select-none">
                    <div class="mt-1">
                        <div class="w-6 h-6 rounded border ${isWatched ? 'bg-green-500 border-green-500' : 'border-slate-600 group-hover:border-slate-400'} flex items-center justify-center transition-all">
                             ${isWatched ? '<span class="text-black text-xs font-bold">‚úì</span>' : ''}
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start mb-1">
                             <h4 class="font-bold text-slate-200 truncate pr-2">${ep.episode_number}. ${ep.name}</h4>
                             <span class="text-[10px] text-slate-500 whitespace-nowrap">${ep.air_date || ''}</span>
                        </div>
                        <p class="text-xs text-slate-400 line-clamp-2 leading-relaxed">${ep.overview || 'No synopsis available.'}</p>
                    </div>
                </div>
                `;
            }).join('');
        }

        async function markSeasonWatched() {
            // Add to set
            currentTracker.watchedSeasons.add(currentTracker.activeSeason);

            // Save to DB
            // We construct the string "1, 2"
            const str = Array.from(currentTracker.watchedSeasons).join(', ');

            await authFetch(`/api/entry/${currentTracker.tmdbId}/progress`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    seasons_watched: str,
                    episode_progress: 0 // Reset ep progress if season done? Or keep max?
                })
            });

            renderSeasonsList();
            // Re-render episodes to show checks
            selectSeason(currentTracker.activeSeason);
        }

        async function toggleEpisode(epNum) {
            const epKey = `S${currentTracker.activeSeason}E${epNum}`;

            if (currentTracker.activeWatchedEpisodes.has(epKey)) {
                currentTracker.activeWatchedEpisodes.delete(epKey);
            } else {
                currentTracker.activeWatchedEpisodes.add(epKey);
            }

            // Re-render immediately
            renderSeasonsList(); // To update checks if logic extended
            await selectSeason(currentTracker.activeSeason); // Refresh list

            // Sync with Server
            await authFetch(`/api/entry/${currentTracker.tmdbId}/progress`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    seasons_watched: Array.from(currentTracker.watchedSeasons).join(', '),
                    episode_progress: currentTracker.activeWatchedEpisodes.size, // Fallback integer
                    watched_episodes: Array.from(currentTracker.activeWatchedEpisodes)
                })
            });
            // No alert needed for toggles usually, just smooth
        }


        // --- Social Logic ---

        function handleUserSearch(query) {
            clearTimeout(searchTimeout);
            if (!query) {
                document.getElementById('user-search-results').classList.add('hidden');
                return;
            }
            searchTimeout = setTimeout(async () => {
                const res = await authFetch(`/api/social/search?q=${encodeURIComponent(query)}`);
                const users = await res.json();

                const container = document.getElementById('user-search-results');
                container.classList.remove('hidden');

                if (users.length === 0) {
                    container.innerHTML = '<div class="text-slate-500 text-sm text-center">No users found</div>';
                    return;
                }

                container.innerHTML = users.map(u => `
                <div class="flex items-center justify-between p-2 hover:bg-white/5 rounded-lg transition-colors">
                        <div class="flex items-center gap-3">
                            <img src="${u.picture}" class="w-8 h-8 rounded-full border border-white/10">
                            <div>
                                <div class="font-medium text-sm text-white flex items-center gap-2">
                                    ${u.name}
                                    ${u.match_score >= 80 ? '<span class="text-[10px] bg-green-500/20 text-green-400 px-1.5 rounded-full">Bestie</span>' : ''}
                                </div>
                                <div class="text-[10px] font-bold ${u.match_score > 70 ? 'text-green-400' : (u.match_score > 40 ? 'text-yellow-400' : 'text-slate-500')}">
                                    ${u.match_score}% Match
                                </div>

                                <!-- Recent + Playlists (Expanded) -->
                                ${u.recent_watches && u.recent_watches.length > 0 ? `
                                    <div class="mt-2 flex gap-1 flex-wrap">
                                        <div class="text-[10px] text-slate-500 font-bold uppercase w-full">3 Recent:</div>
                                        ${u.recent_watches.map(r => `<span class="text-[10px] bg-white/5 px-1.5 py-0.5 rounded text-slate-300 border border-white/5">${r.title}</span>`).join('')}
                                    </div>
                                ` : ''}

                                ${u.playlists && u.playlists.length > 0 ? `
                                    <div class="mt-2 flex gap-1 flex-wrap">
                                        <div class="text-[10px] text-slate-500 font-bold uppercase w-full">Playlists:</div>
                                        ${u.playlists.map(p => `
                                            <div class="flex items-center gap-1 text-[10px] bg-indigo-500/10 text-indigo-300 px-1.5 py-0.5 rounded border border-indigo-500/20">
                                                <i data-lucide="list-music" class="w-3 h-3"></i> ${p.name}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <!-- View Profile Button -->
                            <button onclick="openUserProfile(${u.id})" class="p-1.5 text-slate-400 hover:text-white rounded-lg hover:bg-white/10" title="View Profile">
                                <i data-lucide="user" class="w-4 h-4"></i>
                            </button>
                            <button onclick="openSendRecModal(null, ${u.id}, '${u.name}')" class="p-1.5 text-slate-400 hover:text-white rounded-lg hover:bg-white/10" title="Send Recommendation">
                                <i data-lucide="mail" class="w-4 h-4"></i>
                            </button>
                            <button onclick="toggleFollow(${u.id}, ${u.is_following})" 
                                class="px-3 py-1 text-xs font-bold rounded-full transition-all ${u.is_following ? 'bg-slate-700 text-slate-300' : 'bg-indigo-600 text-white hover:bg-indigo-500'}">
                                ${u.is_following ? 'Following' : 'Follow'}
                            </button>
                        </div>
                    </div>
                `).join('');
            }, 300);
        }

        async function toggleFollow(id, isFollowing) {
            const endpoint = isFollowing ? 'unfollow' : 'follow';
            await authFetch(`/api/social/${endpoint}/${id}`, { method: 'POST' });
            // Refresh search results to update button state
            const val = document.getElementById('user-search-input').value;
            handleUserSearch(val);
            // Refresh feed
            loadFeed();
        }

        async function loadFollowing() {
            const res = await authFetch('/api/social/following');
            if (!res.ok) return;
            const users = await res.json();
            const container = document.getElementById('following-list');

            if (users.length === 0) {
                container.innerHTML = '<div class="text-slate-500 text-xs italic">You are not following anyone yet.</div>';
                return;
            }

            container.innerHTML = users.map(u => `
                <div class="flex items-center gap-3 p-2 hover:bg-white/5 rounded-lg transition-colors group cursor-pointer" onclick="openUserProfile(${u.id})">
                    <img src="${u.picture}" class="w-8 h-8 rounded-full border border-slate-700">
                    <div class="flex-1 overflow-hidden">
                         <div class="truncate text-sm font-bold text-slate-300 group-hover:text-white">${u.name}</div>
                    </div>
                    <button onclick="event.stopPropagation(); toggleFollow(${u.id}, true)" class="text-slate-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-all font-bold text-xs" title="Unfollow">
                        ‚úï
                    </button>
                </div>
            `).join('');
        }

        async function loadFeed() {
            const res = await authFetch('/api/social/feed');
            if (!res) return;
            const feed = await res.json();
            const container = document.getElementById('social-feed-list');

            if (feed.length === 0) {
                container.innerHTML = '<div class="flex flex-col items-center justify-center py-10 opacity-50"><p>It\'s quiet here. Follow people to see activity!</p></div>';
                loadParties(); // Load parties even if feed empty
                return;
            }
            container.innerHTML = feed.map(item => renderFeedItem(item)).join('');
            if (window.lucide) lucide.createIcons();
            loadParties();
        }

        async function openUserProfile(userId) {
            console.log("Opening profile for user:", userId);
            if (!userId) {
                console.error("Invalid user ID");
                return;
            }
            const modal = document.getElementById('user-profile-modal');
            const content = document.getElementById('user-profile-content');
            modal.classList.remove('hidden');

            try {
                const res = await authFetch(`/api/users/${userId}`);
                if (!res.ok) throw new Error("Failed to load user");
                const user = await res.json();

                // Calc Level/XP (Same logic as UpdateProfileUI)
                const levelTitle = getLevelTitle(user.level, 0);
                const currentLevelMinXp = Math.pow((user.level - 1) * 20, 2);
                const nextLevelXp = Math.pow(user.level * 20, 2);
                const progress = Math.min(100, Math.max(0, ((user.xp - currentLevelMinXp) / (nextLevelXp - currentLevelMinXp)) * 100)) || 0;

                content.innerHTML = `
                    <div class="flex flex-col items-center text-center w-full max-w-lg mx-auto">
                        <img src="${user.picture}" class="w-24 h-24 rounded-full border-4 border-white/10 shadow-xl mb-4">
                        <h2 class="text-3xl font-black text-white mb-1">${user.name}</h2>
                            <div class="flex items-center gap-2 mb-4">
                                <span class="px-3 py-1 bg-indigo-600 rounded-full text-xs font-bold text-white uppercase tracking-wider">Lvl ${user.level} ${levelTitle}</span>
                            </div>
                            <p class="text-slate-400 italic mb-6 max-w-md">"${user.bio || 'No bio yet.'}"</p>

                            <!-- Actions -->
                            <div class="flex gap-3 mb-8">
                                <button onclick="toggleFollow(${user.id}, ${user.is_following})"
                                    class="px-6 py-2 rounded-xl font-bold transition-all ${user.is_following ? 'bg-slate-700 text-slate-300' : 'bg-indigo-600 text-white hover:bg-indigo-500'}">
                                    ${user.is_following ? 'Unfollow' : 'Follow'}
                                </button>
                                <button onclick="openSendRecModal(null, ${user.id}, '${user.name}')" class="px-3 py-2 bg-white/10 hover:bg-white/20 text-white rounded-xl font-bold transition-colors">
                                    Send Rec
                                </button>
                                <button onclick="openDMModal(${user.id}, '${user.name}'); document.getElementById('user-profile-modal').classList.add('hidden')" class="px-3 py-2 bg-white/10 hover:bg-white/20 text-white rounded-xl font-bold transition-colors">
                                    <i data-lucide="message-circle" class="w-5 h-5"></i>
                                </button>
                            </div>

                            <!-- Cine Compatibility -->
                            ${user.match_score !== undefined ? `
                        <div class="w-full bg-gradient-to-r from-purple-900/40 to-indigo-900/40 border border-indigo-500/20 p-4 rounded-xl mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-indigo-300 font-bold uppercase text-xs tracking-wider">Cine Compatibility</span>
                                <span class="text-2xl font-black ${user.match_score >= 80 ? 'text-green-400' : (user.match_score >= 50 ? 'text-yellow-400' : 'text-slate-400')}">${user.match_score}%</span>
                            </div>
                            <div class="w-full bg-black/40 h-2 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500" style="width: ${user.match_score}%"></div>
                            </div>
                            <div class="text-[10px] text-slate-500 mt-2 text-right">Based on watched history overlap</div>
                        </div>` : ''}

                            <!-- Stats -->
                            <div class="grid grid-cols-3 gap-4 w-full mb-8">
                                <div class="bg-white/5 p-3 rounded-xl">
                                    <div class="text-xs text-slate-500 uppercase font-bold">XP</div>
                                    <div class="text-xl font-bold text-white">${user.xp.toLocaleString()}</div>
                                </div>
                                <div class="bg-white/5 p-3 rounded-xl">
                                    <div class="text-xs text-slate-500 uppercase font-bold">Streak</div>
                                    <div class="text-xl font-bold text-orange-400 flex items-center justify-center gap-1"><i data-lucide="flame" class="w-4 h-4"></i> ${user.current_streak}</div>
                                </div>
                                <div class="bg-white/5 p-3 rounded-xl">
                                    <div class="text-xs text-slate-500 uppercase font-bold">Rep</div>
                                    <div class="text-xl font-bold text-purple-400">Good</div>
                                </div>
                            </div>

                            <!-- 3 Recent Watched -->
                            ${user.recent_watches && user.recent_watches.length > 0 ? `
                        <div class="w-full mb-8 text-left">
                            <h3 class="text-slate-500 font-bold text-xs uppercase tracking-wider mb-3 pl-1">Recent Activity</h3>
                            <div class="grid grid-cols-3 gap-3">
                                ${user.recent_watches.map(w => `
                                    <div class="glass p-2 rounded-lg relative aspect-[2/3] overflow-hidden group">
                                        <img src="${w.poster_path ? `https://image.tmdb.org/t/p/w200${w.poster_path}` : 'https://via.placeholder.com/200x300'}" class="w-full h-full object-cover rounded">
                                        <div class="absolute inset-0 bg-black/60 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity p-2 text-center">
                                            <span class="text-[10px] font-bold text-white line-clamp-2">${w.title}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>` : ''}

                            <!-- Playlists -->
                            ${user.playlists && user.playlists.length > 0 ? `
                        <div class="w-full mb-8 text-left">
                            <h3 class="text-slate-500 font-bold text-xs uppercase tracking-wider mb-3 pl-1">Public Playlists</h3>
                            <div class="space-y-2">
                                ${user.playlists.map(p => `
                                    <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl border border-white/5 hover:bg-white/10 transition-colors cursor-pointer" onclick="viewPlaylist(${p.id}); document.getElementById('user-profile-modal').classList.add('hidden')">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 rounded bg-indigo-500/20 flex items-center justify-center text-indigo-400">
                                                <i data-lucide="list-music" class="w-4 h-4"></i>
                                            </div>
                                            <div class="font-bold text-slate-200 text-sm">${p.name}</div>
                                        </div>
                                        <div class="text-xs text-slate-500">${p.item_count} items</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>` : ''}

                            <!-- Badges -->
                            <div class="w-full text-left">
                                <h3 class="text-slate-500 font-bold text-xs uppercase tracking-wider mb-3 pl-1">Badges</h3>
                                <div class="flex gap-2 flex-wrap justify-center sm:justify-start">
                                    ${(user.badges || []).map(b => `
                                    <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-lg border border-white/10" title="${b.name}">
                                        ${b.icon.startsWith('http') || b.icon.length > 20 ? `<i data-lucide="${b.icon}" class="w-5 h-5 text-yellow-400"></i>` : b.icon}
                                    </div>
                                `).join('')}
                                </div>
                            </div>
                        </div>
                `;
                if (window.lucide) lucide.createIcons();
            } catch (e) {
                console.error(e);
                content.innerHTML = '<p class="text-red-400">Error loading profile.</p>';
            }
        }


        async function loadParties() {
            // Check if parties container exists (it might be in a specific tab)
            const container = document.getElementById('party-list'); // Changed from 'active-parties-list' to 'party-list'
            if (!container) return; // Exit if element not found (e.g. not in Friends tab)

            try {
                const res = await authFetch('/api/social/parties'); // Assuming endpoint check later
                if (res && res.ok) {
                    const parties = await res.json();
                    if (parties.length === 0) {
                        container.innerHTML = '<div class="text-center text-slate-500 text-xs py-4">No active parties. Host one!</div>';
                    } else {
                        container.innerHTML = parties.map(p => `
                    <div class="bg-indigo-500/10 border border-indigo-500/20 p-3 rounded-xl flex justify-between items-center mb-2">
                                <div>
                                    <div class="font-bold text-indigo-300 text-xs uppercase tracking-wider mb-1">Watch Party</div>
                                    <div class="font-bold text-white text-sm">${p.movie_title || 'Unknown Title'}</div>
                                    <div class="text-[10px] text-slate-400">Hosted by ${p.host_name} ‚Ä¢ ${p.status}</div>
                                </div>
                                <div>
                                    ${p.is_attending
                                ? `<button onclick="enterParty(${p.id}, '${p.movie_title}')" class="px-3 py-1 bg-green-600 hover:bg-green-500 text-white text-xs font-bold rounded-lg flex items-center gap-1"><i data-lucide="door-open" class="w-3 h-3"></i> Enter</button>`
                                : `<button onclick="joinParty(${p.id})" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold rounded-lg">Join</button>`
                            }
                                    ${p.is_host
                                ? `<button onclick="deleteParty(${p.id})" class="mt-2 block w-full text-center text-[10px] text-red-500 hover:text-red-400 font-bold">Cancel Party</button>`
                                : ''}
                                </div>
                            </div>
                    `).join('');
                        if (window.lucide) lucide.createIcons();
                    }
                }
            } catch (e) {
                console.error("Failed to load parties", e);
                container.innerHTML = '<div class="text-center text-red-400 text-xs py-4">Failed to load parties.</div>';
            }
        }

        async function deleteParty(id) {
            if (!confirm("Cancel this watch party? This cannot be undone.")) return;
            try {
                const res = await authFetch(`/api/social/parties/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadParties();
                } else {
                    alert("Failed to delete party.");
                }
            } catch (e) {
                console.error(e);
                alert("Error deleting party.");
            }
        }

        // --- Collaboration Logic ---
        let activeCollabPlaylistId = null;
        let collabSearchTimeout;

        function openCollaborateModal(pid) {
            activeCollabPlaylistId = pid;
            document.getElementById('collaborate-modal').classList.remove('hidden');
            document.getElementById('collab-search').value = '';
            document.getElementById('collab-results').innerHTML = '<div class="text-center text-slate-500 py-8">Start typing to find friends...</div>';
            document.getElementById('collab-search').focus();
        }

        function searchCollaborators(query) {
            clearTimeout(collabSearchTimeout);
            if (!query) {
                document.getElementById('collab-results').innerHTML = '<div class="text-center text-slate-500 py-8">Start typing to find friends...</div>';
                return;
            }

            collabSearchTimeout = setTimeout(async () => {
                const res = await authFetch(`/api/social/search?q=${encodeURIComponent(query)}`);
                if (res.ok) {
                    const users = await res.json();
                    renderCollabResults(users);
                }
            }, 300);
        }

        function renderCollabResults(users) {
            const container = document.getElementById('collab-results');
            if (users.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 py-4">No users found.</div>';
                return;
            }

            container.innerHTML = users.map(u => `
                <div class="flex items-center justify-between p-3 bg-white/5 hover:bg-white/10 rounded-xl transition-colors">
                    <div class="flex items-center gap-3">
                        <img src="${u.picture}" class="w-10 h-10 rounded-full object-cover">
                        <div>
                            <div class="font-bold text-white text-sm">${u.name}</div>
                            <div class="text-xs text-slate-400">${u.match_score}% Match</div>
                        </div>
                    </div>
                    <button onclick="addCollaborator(${u.id})" class="bg-pink-600 hover:bg-pink-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-colors">
                        Add
                    </button>
                </div>
            `).join('');
        }

        async function addCollaborator(uid) {
            if (!activeCollabPlaylistId) return;

            if (confirm("Allow this user to edit this playlist?")) {
                const res = await authFetch(`/api/playlists/${activeCollabPlaylistId}/collaborate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: uid })
                });

                if (res.ok) {
                    const data = await res.json();
                    if (data.status === 'added') {
                        alert("User added as collaborator!");
                        document.getElementById('collaborate-modal').classList.add('hidden');
                    } else {
                        alert("User is already a collaborator.");
                    }
                } else {
                    alert("Failed to add collaborator.");
                }
            }
        }

        async function submitHostParty() {
            const title = document.getElementById('host-party-title').value;
            const date = document.getElementById('host-party-date').value;
            // For MVP, we just create a dummy entry or real one if backend supports
            if (!title) return alert("Title required");

            try {
                // Determine TMDB ID if possible or pass 0
                // This assumes backend has /api/social/parties POST endpoint
                const res = await authFetch('/api/social/parties', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        movie_title: title,
                        scheduled_for: date || new Date().toISOString()
                    })
                });

                if (res.ok) {
                    document.getElementById('host-party-modal').classList.add('hidden');
                    loadParties();
                    alert("Party hosted!");
                } else {
                    alert("Failed to host.");
                }
            } catch (e) {
                console.error(e);
                alert("Error hosting party.");
            }
        }

        // --- Tabs ---
        // --- Tabs ---
        function switchTab(tab) {
            switchView(tab);
        }

        // --- Load Leaderboard ---
        let currentScope = 'global'; // Track state

        async function loadLeaderboard(scope = currentScope) {
            currentScope = scope; // Update state

            // Get Genre
            const genreSelect = document.getElementById('leaderboard-genre');
            const genre = genreSelect ? genreSelect.value : 'All';

            // Update Tab UI
            document.querySelectorAll('#view-leaderboard button').forEach(b => {
                b.className = "px-4 py-2 rounded-full text-sm font-bold bg-white/10 hover:bg-white/20 text-white transition-colors border border-transparent";
            });
            const activeBtn = document.getElementById(`tab-${scope}`);
            if (activeBtn) activeBtn.className = "px-4 py-2 rounded-full text-sm font-bold bg-indigo-600 text-white transition-colors border border-indigo-400";

            const res = await authFetch(`/api/leaderboard?scope=${scope}&genre=${genre}`);
            if (!res.ok) return;
            const data = await res.json();

            const tbody = document.getElementById('leaderboard-list');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-slate-500">No rankings found for this category.</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((u, i) => `
                    <tr class="border-b border-slate-700 hover:bg-white/5 transition-colors">
                    <td class="p-4">
                        <div class="flex items-center gap-2">
                            ${i === 0 ? '<i data-lucide="trophy" class="w-6 h-6 text-yellow-400"></i>' : ''}
                            ${i === 1 ? '<i data-lucide="trophy" class="w-5 h-5 text-slate-300"></i>' : ''}
                            ${i === 2 ? '<i data-lucide="trophy" class="w-4 h-4 text-orange-400"></i>' : ''}
                            ${i > 2 ? `<span class="font-mono text-slate-500 font-bold ml-2">#${i + 1}</span>` : ''}
                        </div>
                    </td>
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <img src="${u.picture}" class="w-10 h-10 rounded-full border border-slate-600">
                            <span class="font-bold text-white">${u.name}</span>
                        </div>
                    </td>
                    <td class="p-4">
                        <span class="font-mono text-indigo-400">${u.hours}h</span>
                    </td>
                    <td class="p-4">
                        <span class="text-xs bg-white/10 px-2 py-1 rounded-full text-slate-300">${u.vibe}</span>
                    </td>
                    <td class="p-4">
                         <span class="text-xs text-slate-500">${u.city || ''} ${u.country ? '(' + u.country + ')' : ''}</span>
                    </td>
                </tr>
                    `).join('');
        }

        // Global switcher for Bottom Nav & Tabs
        // Global switcher for Bottom Nav & Tabs
        function switchView(viewName) {
            // Hide all views
            ['watchlist', 'history', 'analytics', 'report', 'social', 'leaderboard', 'playlists'].forEach(t => {
                const el = document.getElementById(`view-${t}`);
                if (el) el.classList.add('hidden');
            });

            // Show Target
            const target = document.getElementById(`view-${viewName}`);
            if (target) {
                target.classList.remove('hidden');

                if (viewName === 'analytics') {
                    loadRecs();
                    loadSprint();
                }
                if (viewName === 'social') {
                    loadFeed();
                    loadFollowing();
                }
                if (viewName === 'playlists') {
                    loadMyPlaylists();
                }
                if (viewName === 'leaderboard') {
                    loadLeaderboard();
                }
                if (viewName === 'report') {
                    // Seasonality Logic: Dec 1 - Dec 30
                    const d = new Date();
                    const month = d.getMonth(); // 0-11, 11 is Dec
                    const day = d.getDate();
                    const isSeason = month === 11 && day >= 1 && day <= 30;
                    // const isSeason = true; // FORCE DEBUG (Uncomment to test out of season)

                    if (isSeason) {
                        StoryManager.start();
                    } else {
                        switchView('leaderboard');
                        alert("Wrapped is only available Dec 1st - 30th! Redirecting to Rankings.");
                    }
                }
            }

            // Update Active State (Nav)
            // ... (optional visual update for nav buttons)
        }


        async function loadReport() {
            const stats = await fetchStats();
            if (!stats) return;

            // 1. Vibe
            const topGenre = stats.top_genres.length > 0 ? stats.top_genres[0][0] : 'Explorer';
            document.getElementById('report-vibe').innerText = topGenre;

            // 2. Numbers
            document.getElementById('report-minutes').innerText = stats.total_runtime_minutes.toLocaleString();
            document.getElementById('report-movies').innerText = stats.counts.movies;
            document.getElementById('report-series').innerText = stats.counts.series;

            // NEW: Temporal Stats
            if (stats.top_month) {
                document.getElementById('report-month').innerText = stats.top_month[0];
                document.getElementById('report-month-count').innerText = `${stats.top_month[1]} items`;
            }
            if (stats.top_day) {
                document.getElementById('report-day').innerText = stats.top_day[0];
                document.getElementById('report-day-count').innerText = `${stats.top_day[1]} items`;
            }

            // Helper for Lists (Clickable)
            const renderList = (items, colorClass, category) => {
                return items.slice(0, 5).map((item, i) => `
                    <li onclick="openDrillDown('${category}', '${item[0].replace(/'/g, "\\'")}')" class="flex items-center gap-4 group cursor-pointer p-2 rounded-xl hover:bg-white/5 transition-colors">
                        <span class="font-black text-2xl w-8 text-right text-slate-700 group-hover:${colorClass} transition-colors"> ${i + 1}</span>
                        <span class="font-bold text-xl text-slate-300 group-hover:text-white transition-colors truncate flex-1 text-left">${item[0]}</span>
                        <span class="text-xs font-mono text-slate-500 group-hover:text-white/50">${item[1]}</span>
                        <span class="opacity-0 group-hover:opacity-100 text-white/50">‚Üí</span>
                    </li>
                    `).join('');
            };

            // 3. Top Genres
            document.getElementById('report-genres-list').innerHTML = renderList(stats.top_genres, 'text-yellow-400', 'genre');

            // 4. Top Studios
            document.getElementById('report-studios-list').innerHTML = renderList(stats.top_studios, 'text-blue-400', 'studio');

            // 5. Top Cast
            document.getElementById('report-cast-list').innerHTML = renderList(stats.top_cast, 'text-purple-400', 'cast');

            // NEW: Top Directors (Crew)
            // Assuming HTML container exists or we inject it into the Cast card or a new one.
            // For now, let's append it to the Cast list container logic or reuse the Cast card logic if we had distinct slots. 
            // Wait, I need to add a "Top Crew" section in the HTML grid first?
            // Actually, I can repurpose the "Studios" section in the HTML if desired, but better to add a new list.
            // Since I cannot rewrite the entire grid easily in one go, I will inject it dynamically into the report container or replace the "Studios" column if user prefers?
            // "I cant' find the producer/ director's modal" -> Implies they want it.
            // I'll create a new section dynamically for now to ensure it appears.

            const crewHTML = `
                    <div class="animate-up delay-300 col-span-1 md:col-span-2 glass rounded-3xl p-6 relative overflow-hidden">
                    <div class="flex justify-between items-end mb-4 relative z-10">
                        <div>
                            <h3 class="text-slate-400 font-bold text-xs uppercase tracking-widest">Top Directors</h3>
                            <div class="text-3xl font-black text-white">Visionaries</div>
                        </div>
                    </div>
                    <ul class="space-y-4 relative z-10" id="report-crew-list"></ul>
                </div>
                    `;
            // Check if we already added it? No.
            // We need to inject this into the grid. 
            // Finding the parent grid... `report-studios-list` parent.
            const studiosCard = document.getElementById('report-studios-list').parentElement.parentElement;
            if (!document.getElementById('report-crew-list')) {
                studiosCard.insertAdjacentHTML('afterend', crewHTML);
            }
            document.getElementById('report-crew-list').innerHTML = renderList(stats.top_crew || [], 'text-pink-400', 'crew');

            // 6. Keywords (Cloud)
            document.getElementById('report-keywords-list').innerHTML = stats.top_keywords.map((k, i) => {
                const sizes = ['text-3xl', 'text-2xl', 'text-xl', 'text-lg', 'text-base'];
                const size = sizes[i] || 'text-sm';
                const opacity = Math.max(0.4, 1 - (i * 0.1));
                return `<span class="${size} font-bold text-white" style="opacity: ${opacity}"> ${k[0]}</span>`;
            }).join(' <span class="text-slate-600">‚Ä¢</span> ');

            // 7. Trivia
            if (stats.trivia && stats.trivia.length > 0) {
                const randomTrivia = stats.trivia[Math.floor(Math.random() * stats.trivia.length)];
                document.getElementById('report-trivia-text').innerText = randomTrivia;
            } else {
                document.getElementById('report-trivia-card').classList.add('hidden');
            }

            // 8. Persona & Ranking Logic
            const topG = stats.top_genres.map(g => g[0]);
            let persona = "Movie Buff";
            let rank = "Top 5% Viewer";

            if (topG.includes('Science Fiction') && topG.includes('Thriller')) persona = "Chaos Rider";
            else if (topG.includes('Romance') && topG.includes('Drama')) persona = "Heartbreaker";
            else if (topG.includes('Action') && topG.includes('Adventure')) persona = "Adrenaline Junkie";
            else if (topG.includes('Comedy')) persona = "Laugh Factory";
            else if (topG.includes('Horror')) persona = "Scream Queen";

            const hours = Math.round(stats.total_runtime_minutes / 60);
            const primaryGenre = topG.length > 0 ? topG[0] : 'Movie';
            if (hours > 100) rank = `Top 1% ${primaryGenre} Fan`;
            else if (hours > 50) rank = `Top 5% ${primaryGenre} Fan`;
            else rank = `Top 20% ${primaryGenre} Fan`;

            document.getElementById('report-vibe').innerText = persona;
            document.getElementById('report-rank').innerText = rank;

            // Trigger Confetti
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#6366f1', '#a855f7', '#ec4899']
            });
            setTimeout(() => {
                confetti({
                    particleCount: 50,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 }
                });
                confetti({
                    particleCount: 50,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 }
                });
            }, 500);
        }

        // --- ADD TO PLAYLIST LOGIC ---
        // --- ADD TO PLAYLIST LOGIC ---
        let currentAddTmdbId = null;
        let currentAddTitle = null;
        let currentAddMediaType = null;
        let currentAddPosterPath = null;

        async function openAddToPlaylistModal(tmdbId, title, mediaType, posterPath) {
            currentAddTmdbId = tmdbId;
            currentAddTitle = title;
            currentAddMediaType = mediaType || 'movie';
            currentAddPosterPath = posterPath;

            const modal = document.getElementById('add-to-playlist-modal');
            const list = document.getElementById('add-to-playlist-list');

            modal.classList.remove('hidden');
            list.innerHTML = '<div class="text-center text-slate-500 py-4">Loading...</div>';

            try {
                // Fetch user playlists
                const res = await authFetch('/api/playlists');
                if (res && res.ok) {
                    const playlists = await res.json();
                    if (playlists.length === 0) {
                        list.innerHTML = '<div class="text-center text-slate-500 py-4">No playlists found. Create one!</div>';
                    } else {
                        list.innerHTML = playlists.map(p => `
                    <button onclick="submitAddToPlaylist(${p.id})"
                class="w-full text-left px-4 py-3 bg-slate-800 hover:bg-slate-700 rounded-xl transition-colors flex items-center justify-between group" >
                                <span class="font-bold text-slate-200">${p.name}</span>
                                <span class="text-xs text-slate-500 group-hover:text-white transition-colors">Add +</span>
                            </button >
                    `).join('');
                    }
                }
            } catch (e) {
                list.innerHTML = '<div class="text-center text-red-400">Error loading lists</div>';
            }
        }

        async function submitAddToPlaylist(pid) {
            if (!currentAddTmdbId) return;

            try {
                const res = await authFetch(`/api/playlists/${pid}/items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tmdb_id: currentAddTmdbId,
                        title: currentAddTitle,
                        media_type: currentAddMediaType,
                        poster_path: currentAddPosterPath
                    })
                });

                if (res && res.ok) {
                    alert("Added to playlist!");
                    document.getElementById('add-to-playlist-modal').classList.add('hidden');
                } else {
                    alert("Failed to add (maybe already exists?)");
                }
            } catch (e) {
                console.error(e);
            }
        }


        // --- REWATCH / BLOCK LOGIC ---
        async function submitRewatch(tmdbId, title) {
            if (!confirm(`Re - watch "${title}" ? This will add to your XP.`)) return;

            try {
                const res = await authFetch(`/ api / history / ${tmdbId}/rewatch`, { method: 'POST' });
                if (res && res.ok) {
                    const data = await res.json();
                    alert(`Re-watched! +${data.xp_gained} XP`);
                    // Refresh stats
                    init();
                }
            } catch (e) { console.error(e); }
        }

        async function submitBlock(tmdbId, title) {
            if (!confirm(`Hide "${title}" from your lists?`)) return;

            try {
                const res = await authFetch(`/api/history/${tmdbId}/block`, { method: 'POST' });
                if (res && res.ok) {
                    // Remove from DOM immediately
                    const card = document.getElementById(`card-${tmdbId}`);
                    if (card) card.remove();
                }
            } catch (e) { console.error(e); }
        }



        // Auto-Refresh Logic
        function startAutoRefresh() {
            setInterval(async () => {
                // Background update without full UI flicker?
                if (document.visibilityState === 'visible') {
                    const res = await authFetch('/api/stats');
                    if (res && res.ok) {
                        const stats = await res.json();
                        const currentCount = parseInt(document.getElementById('stat-watchlist').innerText || '0') +
                            parseInt(document.getElementById('stat-watched').innerText || '0');

                        const newCount = (stats.counts?.watchlist || 0) + (stats.counts?.watched || 0);

                        // Only full refresh if data changed
                        if (newCount !== currentCount) {
                            console.log("Data changed, refreshing UI...");
                            init();
                        }
                    }
                }
            }, 30000); // 30s
        }

        function renderGenrePills() {
            // Get all unique genres from FULL history (not just watched)
            // But usually we filter history. Watchlist too?
            // Let's use window.historyData and window.watchlistData combined or just history?
            // The prompt implies filtering "Lists". Let's support both if possible.
            // For now, let's derive genres from History as it has more data usually.

            const allItems = [...(window.historyData || []), ...(window.watchlistData || [])];
            console.log("DEBUG: renderGenrePills items:", allItems.length);
            const genres = new Set();
            allItems.forEach(i => {
                if (i.genres) {
                    // It's a JSON string in DB, or list if parsed.
                    // authFetch parses JSON response? Yes.
                    // In DB it is stored as JSON string `["Action", "Comedy"]`.
                    // The API likely returns it as a list.
                    // Let's check `fetchHistory`... it returns raw objects.
                    // The `genres` field might be a list of strings OR a string.
                    // Need to handle both.
                    let gList = i.genres;
                    if (typeof gList === 'string') {
                        // Try parsing as JSON first, fallback to comma-separated
                        if (gList.startsWith('[')) {
                            try { gList = JSON.parse(gList); } catch (e) { gList = []; }
                        } else {
                            gList = gList.split(',').map(s => s.trim());
                        }
                    }
                    if (Array.isArray(gList)) {
                        gList.forEach(g => genres.add(typeof g === 'object' ? g.name : g));
                    }
                }
            });

            const sorted = Array.from(genres).sort();
            const container = document.getElementById('genre-filter-list');
            if (!container) return;

            container.innerHTML = sorted.map(g => `
                <button onclick="toggleGenre('${g}')" 
                    class="px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap transition-colors border border-white/10 ${selectedGenre === g ? 'bg-indigo-500 text-white' : 'bg-white/5 text-slate-400 hover:bg-white/10 hover:text-white'}">
                    ${g}
                </button>
            `).join('');
        }



        function setFilterType(type) {
            currentFilterType = type;
            // Update UI
            ['all', 'movie', 'tv', 'blocked'].forEach(t => {
                const btn = document.getElementById(`filter-${t}`);
                if (btn) {
                    if (t === type) {
                        btn.classList.add('bg-white', 'text-black');
                        btn.classList.remove('bg-white/10', 'text-white');
                    } else {
                        btn.classList.remove('bg-white', 'text-black');
                        btn.classList.add('bg-white/10', 'text-white');
                    }
                }
            });
            renderGridWithFilters();
        }

        function toggleGenre(genre) {
            if (selectedGenre === genre) {
                selectedGenre = null; // Toggle off
            } else {
                selectedGenre = genre;
            }
            renderGenrePills();
            renderGridWithFilters();
        }

        function renderGridWithFilters() {
            // Filter Blocked (Anti-Watchlist)
            if (window.historyData && currentFilterType === 'blocked') {
                const filteredB = window.historyData.filter(i => i.status === 'blocked');
                document.getElementById('history-grid').innerHTML = filteredB.length > 0
                    ? filteredB.map(i => renderCard(i, false, true)).join('')
                    : '<div class="col-span-full text-center text-slate-500 py-10">No blocked items yet</div>';
                document.getElementById('watchlist-grid').innerHTML = '';
                return;
            }

            // Filter History
            if (window.historyData) {
                const filteredH = window.historyData.filter(i => {
                    const matchType = currentFilterType === 'all' || i.media_type === currentFilterType;
                    const matchGenre = !selectedGenre || (JSON.stringify(i.genres).includes(selectedGenre));
                    // Check status just in case
                    return i.status === 'watched' && matchType && matchGenre;
                });
                document.getElementById('history-grid').innerHTML = filteredH.map(i => renderCard(i, false)).join('');
            }

            // Filter Watchlist? (If we had a watchlist grid... yes we do)
            if (window.watchlistData) {
                const filteredW = window.watchlistData.filter(i => {
                    const matchType = currentFilterType === 'all' || i.media_type === currentFilterType;
                    const matchGenre = !selectedGenre || (JSON.stringify(i.genres).includes(selectedGenre));
                    return i.status === 'watchlist' && matchType && matchGenre;
                });
                document.getElementById('watchlist-grid').innerHTML = filteredW.map(i => renderCard(i, true)).join('');
            }
            if (window.lucide) lucide.createIcons();
        }

        // Manual Add Functions
        function openAddModal() { document.getElementById('add-modal').classList.remove('hidden'); }

        async function openDrillDown(category, value) {
            const modal = document.getElementById('drilldown-modal');
            const grid = document.getElementById('drilldown-grid');
            const title = document.getElementById('drilldown-title');

            // Set Title
            title.innerText = `${value} (${category})`;

            // Show Loading
            modal.classList.remove('hidden');
            grid.innerHTML = '<div class="col-span-full text-center py-20 text-white/50 animate-pulse">Digging through the archives...</div>';

            // Fetch
            try {
                const res = await authFetch(`/api/stats/details?category=${category}&value=${encodeURIComponent(value)}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.length === 0) {
                        grid.innerHTML = '<div class="col-span-full text-center py-20 text-white/50">No items found (ghost data?)</div>';
                    } else {
                        grid.innerHTML = data.map(i => renderRecCard(i)).join(''); // Reuse rec card renderer
                    }
                }
            } catch (e) {
                grid.innerHTML = '<div class="col-span-full text-center py-20 text-red-400">Error fetching details.</div>';
            }
        }

        // --- STORY MANAGER ---
        const StoryManager = {
            data: null,
            stories: [],
            currentIndex: 0,
            timer: null,
            audio: null,
            duration: 10000,
            isPaused: false,

            init() {
                // Audio Tracks Map
                this.tracks = [
                    'https://pixabay.com/music/download/audio/112674/', // Cinematic
                    'https://pixabay.com/music/download/audio/112151/', // Upbeat
                    'https://pixabay.com/music/download/audio/13697/'   // Emotional
                ];
                // Try to load first
                this.audio = new Audio(this.tracks[0]);
                this.audio.loop = true;
                this.audio.volume = 0.3;
            },

            generateStories() {
                const s = this.data;
                const slides = [];

                // 1. Intro
                slides.push({ type: 'intro', data: s });

                // 2. Vibe
                slides.push({ type: 'vibe', data: s });

                // 3. Stats
                slides.push({ type: 'stats', data: s });

                // 4. Genres
                if (s.top_genres.length > 0) {
                    slides.push({ type: 'genres', data: s });
                }

                // NEW: 4b. Top Cast
                if (s.top_cast && s.top_cast.length > 0) {
                    slides.push({ type: 'cast', data: s });
                }

                // 5. Global (Countries)
                if (s.top_countries && s.top_countries.length > 0) {
                    slides.push({ type: 'countries', data: s });
                }

                if (s.top_day) {
                    slides.push({ type: 'heat', data: s });
                }

                // NEW: 5d. Rhythm (Time of Day)
                if (s.counts && s.counts.day_parts) {
                    slides.push({ type: 'rhythm', data: s });
                }

                // NEW: 5c. Completionist
                if (s.counts.completion_rate > 50) {
                    slides.push({ type: 'completion', data: s });
                }

                // 6. Trivia
                if (s.trivia.length > 0) {
                    slides.push({ type: 'trivia', data: s });
                }

                // --- WRAPPED V2 SLIDES ---
                if (s.wrapped) {
                    if (s.wrapped.most_rewatched) slides.push({ type: 'rewatch', data: s.wrapped.most_rewatched });
                    if (s.wrapped.longest_movie) slides.push({ type: 'timelord', data: s.wrapped });
                    if (s.wrapped.top_era) slides.push({ type: 'era', data: s.wrapped.top_era });
                    if (s.wrapped.social_rank) slides.push({ type: 'social', data: s.wrapped });
                    if (s.wrapped.city_rank !== "N/A") slides.push({ type: 'city', data: s.wrapped.city_rank });
                    if (s.wrapped.soulmate) slides.push({ type: 'soulmate', data: s.wrapped.soulmate });
                    if (s.wrapped.streak > 1) slides.push({ type: 'streak', data: s.wrapped.streak });
                    if (s.wrapped.critic_persona) slides.push({ type: 'critic', data: s.wrapped });
                }



                // 7. Outro
                slides.push({ type: 'outro', data: s });

                this.slides = slides; // Store locally for navigation
                return slides;
            },

            drillDownCountry(countryCode) {
                this.pause();
                // Find items from this country
                // We don't have full list in stats, need to use drilldown endpoint
                openDrillDown('country', countryCode);
            },


            async start() {
                const stats = await fetchStats();
                if (!stats) return;
                this.data = stats;

                // Prepare Slides
                this.stories = this.generateStories();
                const year = new Date().getFullYear();
                if (this.stories.length === 0) return alert(`Not enough data for ${year} Wrapped!`);

                this.currentIndex = 0;
                document.getElementById('story-overlay').classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                this.renderProgress();
                this.showSlide(0); // Start the show

                // Play Audio
                if (!this.tracks || this.tracks.length === 0) this.init();
                const randomTrack = this.tracks[Math.floor(Math.random() * this.tracks.length)];
                this.audio.src = randomTrack;
                this.audio.play().catch(e => console.log("Audio play failed (user interaction needed):", e));
            },

            // Alias for safety if called elsewhere
            renderStory() {
                this.showSlide(this.currentIndex);
            },

            close() {
                document.getElementById('story-overlay').classList.add('hidden');
                document.body.style.overflow = 'auto';
                clearTimeout(this.timer);
                if (this.audio) {
                    this.audio.pause();
                    this.audio.currentTime = 0;
                }
                // Stay on current view (Report) to allow interaction
            },

            next() {
                if (this.currentIndex < this.slides.length - 1) {
                    this.showSlide(this.currentIndex + 1);
                } else {
                    this.close();
                }
            },

            prev() {
                if (this.currentIndex > 0) {
                    this.showSlide(this.currentIndex - 1);
                }
            },

            pause() {
                this.isPaused = true;
                document.getElementById('story-overlay').classList.add('paused');
                // Pause animation
                const fill = document.querySelectorAll('.story-progress-fill')[this.currentIndex];
                if (fill) fill.style.animationPlayState = 'paused';
                clearTimeout(this.timer);
            },

            resume() {
                this.isPaused = false;
                document.getElementById('story-overlay').classList.remove('paused');
                const fill = document.querySelectorAll('.story-progress-fill')[this.currentIndex];
                if (fill) fill.style.animationPlayState = 'running';
                // Resume timer roughly? Easier to just restart slide or let user click next. 
                // For simple MVP: just restart the 5s timer implies extended view. 
                // Better: Calculate remaining time. Complexity high.
                // Simple: Restart full duration for this slide on resume, or just auto-advance after a short delay?
                // Visual sync issues if we just restart timer. 
                // Let's just restart CSS animation and Timer for simplicity in MVP 1.0 or just rely on CSS 'animationend' event?
                // Re-triggering showSlide(current) works but resets progress bar.
                // Let's just auto-advance after 2s if released? No. 
                // Proper way: CSS animation end triggers next.
            },

            renderProgress() {
                const container = document.getElementById('story-progress-container');
                container.innerHTML = this.slides.map((_, i) => `
            <div class="story-progress-bar" >
                <div class="story-progress-fill" id="progress-${i}"></div>
                    </div >
            `).join('');
            },

            showSlide(index) {
                clearTimeout(this.timer);
                this.currentIndex = index;

                // Update Bars
                this.slides.forEach((_, i) => {
                    const fill = document.getElementById(`progress-${i}`);
                    fill.style.width = i < index ? '100%' : '0%';
                    fill.style.animation = 'none';
                });

                // Animate Current Bar
                const currentFill = document.getElementById(`progress-${index}`);
                currentFill.style.width = '0%';
                // Trigger reflow
                void currentFill.offsetWidth;
                currentFill.style.animation = `progress ${this.duration}ms linear forwards`;

                // Render Content
                const slide = this.slides[index];
                const content = document.getElementById('story-content');
                content.innerHTML = this.getSlideHTML(slide);

                // Auto Advance
                this.timer = setTimeout(() => {
                    this.next();
                }, this.duration);

                // Trigger Confetti on Outro
                if (slide.type === 'outro') {
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                }
            },

            getSlideHTML(slide) {
                const s = slide.data;
                const commonClass = "flex flex-col items-center text-center animate-up max-w-2xl";

                if (slide.type === 'intro') {
                    const year = new Date().getFullYear();
                    return `
            <div class="${commonClass}">
                            <h1 class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 mb-4">${year}<br>WRAPPED</h1>
                            <p class="text-xl text-slate-400">Your year in entertainment.</p>
                        </div >
            `;
                }

                if (slide.type === 'vibe') {
                    // Logic for Persona
                    const topG = s.top_genres.map(g => g[0]);
                    let persona = "Movie Buff";
                    let emoji = "üé¨";
                    if (topG.includes('Science Fiction')) { persona = "Time Traveler"; emoji = "üöÄ"; }
                    else if (topG.includes('Horror')) { persona = "Fearless"; emoji = "üò±"; }
                    else if (topG.includes('Comedy')) { persona = "Chief Laugh Officer"; emoji = "üòÇ"; }
                    else if (topG.includes('Romance')) { persona = "Hopeless Romantic"; emoji = "üíù"; }

                    return `
            <div class="${commonClass}">
                            <div class="text-9xl mb-6 animate-bounce">${emoji}</div>
                            <h2 class="text-3xl font-bold text-slate-300 uppercase tracking-widest mb-2">Your Vibe</h2>
                            <h1 class="text-6xl font-black text-white">${persona}</h1>
                            <p class="mt-4 text-xl text-indigo-300">${s.top_genres[0] ? s.top_genres[0][0] : ''} lover</p>
                        </div>
            `;
                }

                if (slide.type === 'stats') {
                    return `
            <div class="${commonClass}">
                            <h2 class="text-2xl font-bold text-slate-400 uppercase tracking-widest mb-8">The Hard Numbers</h2>
                            <div class="grid grid-cols-2 gap-8 w-full">
                                <div class="bg-white/10 p-6 rounded-3xl backdrop-blur-md">
                                    <div class="text-5xl font-black text-yellow-400">${Math.round(s.total_runtime_minutes / 60)}</div>
                                    <div class="text-sm font-bold text-white uppercase mt-2">Hours Watched</div>
                                </div>
                                <div class="bg-white/10 p-6 rounded-3xl backdrop-blur-md">
                                    <div class="text-5xl font-black text-green-400">${s.counts.watchlist + s.counts.watched}</div>
                                    <div class="text-sm font-bold text-white uppercase mt-2">Total Items</div>
                                </div>
                                <div class="bg-white/10 p-6 rounded-3xl backdrop-blur-md">
                                    <div class="text-5xl font-black text-blue-400">${s.counts.movies}</div>
                                    <div class="text-sm font-bold text-white uppercase mt-2">Movies</div>
                                </div>
                                <div class="bg-white/10 p-6 rounded-3xl backdrop-blur-md">
                                    <div class="text-5xl font-black text-purple-400">${s.counts.series}</div>
                                    <div class="text-sm font-bold text-white uppercase mt-2">Shows</div>
                                </div>
                            </div>
                        </div>
            `;
                }

                if (slide.type === 'genres') {
                    const list = s.top_genres.slice(0, 5).map((g, i) => `
            <div class="flex items-center gap-4 w-full p-3 bg-white/5 rounded-xl mb-2">
                             <span class="text-xl font-bold text-slate-500">#${i + 1}</span>
                             <span class="text-2xl font-bold text-white">${g[0]}</span>
                        </div>
            `).join('');
                    return `
            <div class="${commonClass} w-full max-w-md">
                            <h2 class="text-3xl font-black text-white mb-6">Top Genres</h2>
                            <div class="w-full text-left">
                                ${list}
                            </div>
                        </div >
            `;
                }

                if (slide.type === 'cast') {
                    const actor = s.top_cast[0];
                    return `
            <div class="${commonClass}">
                            <div class="mb-6 animate-pulse text-yellow-500"><i data-lucide="star" class="w-16 h-16"></i></div>
                            <h2 class="text-xl font-bold text-yellow-400 uppercase tracking-widest mb-4">Star Struck</h2>
                            <h1 class="text-5xl font-black text-white mb-2">${actor[0]}</h1>
                            <p class="text-slate-400">You watched them ${actor[1]} times.</p>
                        </div >
            `;
                }

                if (slide.type === 'heat') {
                    // s.top_day is ["DayName", count]
                    return `
            <div class="${commonClass}">
                            <div class="text-6xl mb-6">üî•</div>
                            <h2 class="text-xl font-bold text-red-400 uppercase tracking-widest mb-4">Binge Day</h2>
                            <h1 class="text-5xl font-black text-white mb-2">${s.top_day[0]}s</h1>
                            <p class="text-slate-400">Are your favorite day to disappear.</p>
                        </div >
            `;
                }

                if (slide.type === 'rhythm') {
                    // Find max
                    const maxPart = Object.entries(s.counts.day_parts).reduce((a, b) => a[1] > b[1] ? a : b);
                    let title = "Night Owl ü¶â";
                    if (maxPart[0].includes("Morning")) title = "Early Bird üåÖ";
                    else if (maxPart[0].includes("Afternoon")) title = "Day Dreamer ‚òÄÔ∏è";
                    else if (maxPart[0].includes("Evening")) title = "Evening Star üåá";

                    return `
            <div class="${commonClass}">
                            <div class="text-6xl mb-6">üï∞Ô∏è</div>
                            <h2 class="text-xl font-bold text-blue-400 uppercase tracking-widest mb-4">Your Rhythm</h2>
                            <h1 class="text-5xl font-black text-white mb-2">${title}</h1>
                            <p class="text-slate-400">You watch most during the ${maxPart[0].split(' ')[0]}.</p>
                            <div class="grid grid-cols-2 gap-4 mt-6 w-full text-xs text-slate-500">
                                ${Object.entries(s.counts.day_parts).map(([k, v]) => `
                                    <div class="bg-white/5 p-2 rounded flex justify-between">
                                        <span>${k.split(' ')[0]}</span>
                                        <span class="text-white font-bold">${v}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
            `;
                }

                if (slide.type === 'completion') {
                    return `
            <div class="${commonClass}">
                            <div class="text-6xl mb-6">‚úÖ</div>
                            <h2 class="text-xl font-bold text-green-400 uppercase tracking-widest mb-4">The Finisher</h2>
                            <h1 class="text-6xl font-black text-white mb-2">${s.counts.completion_rate}%</h1>
                            <p class="text-slate-400">Completion Rate. You don't leave things hanging.</p>
                        </div >
            `;
                }

                if (slide.type === 'trivia') {
                    const fact = s.trivia.length > 0 ? s.trivia[0] : "You really love movies!";
                    return `
            <div class="${commonClass}">
                            <div class="text-6xl mb-6">üí°</div>
                            <h2 class="text-xl font-bold text-indigo-400 uppercase tracking-widest mb-4">Did You Know?</h2>
                            <p class="text-3xl font-bold text-white leading-relaxed">"${fact}"</p>
                        </div >
            `;
                }

                if (slide.type === 'outro') {
                    return `
            <div class="${commonClass}">
                            <div class="bg-gradient-to-br from-indigo-600 to-purple-600 p-8 rounded-full mb-6 shadow-[0_0_100px_rgba(99,102,241,0.5)]">
                                <span class="text-6xl font-black text-white">#1</span>
                            </div>
                            <h2 class="text-3xl font-bold text-white mb-2">Top 5% Viewer</h2>
                            <p class="text-slate-400 mb-8">You watched more than 95% of the world!</p>
                            <button onclick="StoryManager.close()" class="bg-white text-black font-bold py-3 px-8 rounded-full text-lg hover:scale-105 transition-transform">
                                Explore Dashboard
                            </button>
                        </div>
            `;
                }

                // --- WRAPPED V2 RENDERERS ---
                if (slide.type === 'rewatch') {
                    const m = slide.data;
                    return `
                        <div class="${commonClass}">
                            <div class="text-6xl mb-6">üîÅ</div>
                            <h2 class="text-xl font-bold text-pink-400 uppercase tracking-widest mb-4">On Repeat</h2>
                            <img src="https://image.tmdb.org/t/p/w300${m.poster}" class="w-48 rounded-xl shadow-2xl mb-4 rotate-3 border-4 border-white/10">
                            <h1 class="text-3xl font-black text-white mb-2 leading-tight">${m.title}</h1>
                            <p class="text-slate-400">You watched it <span class="text-white font-bold">${m.count} times</span>.</p>
                        </div>
                    `;
                }

                if (slide.type === 'timelord') {
                    const w = slide.data;
                    return `
                        <div class="${commonClass}">
                            <div class="text-6xl mb-6">‚è≥</div>
                            <h2 class="text-xl font-bold text-purple-400 uppercase tracking-widest mb-4">Time Lord</h2>
                            <div class="grid grid-cols-2 gap-4 text-left w-full max-w-lg">
                                <div class="bg-white/5 p-4 rounded-2xl">
                                    <div class="text-xs text-slate-500 uppercase">Longest Haul</div>
                                    <div class="font-bold text-white truncate">${w.longest_movie.title}</div>
                                    <div class="text-2xl font-black text-purple-300">${w.longest_movie.runtime}m</div>
                                </div>
                                <div class="bg-white/5 p-4 rounded-2xl">
                                    <div class="text-xs text-slate-500 uppercase">Quickest Fix</div>
                                    <div class="font-bold text-white truncate">${w.shortest_movie.title}</div>
                                    <div class="text-2xl font-black text-purple-300">${w.shortest_movie.runtime}m</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                if (slide.type === 'era') {
                    return `
                        <div class="${commonClass}">
                            <div class="text-6xl mb-6">üï∞Ô∏è</div>
                            <h2 class="text-xl font-bold text-yellow-500 uppercase tracking-widest mb-4">Time Traveler</h2>
                            <h1 class="text-6xl font-black text-white mb-2">${slide.data[0]}</h1>
                            <p class="text-slate-400">You belong in this decade.</p>
                        </div>
                    `;
                }

                if (slide.type === 'social') {
                    const pic = slide.data.top_friend_name === "You" ? "üèÜ" : "ü•à";
                    return `
                        <div class="${commonClass}">
                            <div class="text-6xl mb-6">üëØ</div>
                            <h2 class="text-xl font-bold text-indigo-400 uppercase tracking-widest mb-4">Social Rank</h2>
                            <h1 class="text-6xl font-black text-white mb-2">#${slide.data.social_rank}</h1>
                            <p class="text-slate-400 mb-6">Among ${slide.data.total_friends_compared} friends</p>
                            <div class="bg-white/10 p-4 rounded-xl flex items-center gap-4">
                                <span class="text-3xl">${pic}</span>
                                <div class="text-left">
                                    <div class="text-xs text-slate-400">Most Screen Time</div>
                                    <div class="font-bold text-white text-xl">${slide.data.top_friend_name}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                if (slide.type === 'city') {
                    return `
                        <div class="${commonClass}">
                            <div class="text-6xl mb-6">üèôÔ∏è</div>
                            <h2 class="text-xl font-bold text-cyan-400 uppercase tracking-widest mb-4">Hometown Hero</h2>
                            <h1 class="text-5xl font-black text-white mb-2">${slide.data}</h1>
                            <p class="text-slate-400">In your city.</p>
                        </div>
                    `;
                }

                if (slide.type === 'soulmate') {
                    const friend = slide.data;
                    return `
                        <div class="${commonClass}">
                            <div class="text-6xl mb-6">üíñ</div>
                            <h2 class="text-xl font-bold text-pink-500 uppercase tracking-widest mb-4">Cine-Soulmate</h2>
                            <div class="relative mb-6">
                                <img src="${friend.pic}" class="w-32 h-32 rounded-full border-4 border-pink-500 mx-auto">
                                <div class="absolute -bottom-2 -right-2 bg-pink-600 text-white font-bold px-3 py-1 rounded-full text-sm">${friend.score}%</div>
                            </div>
                            <h1 class="text-4xl font-black text-white mb-2">${friend.name}</h1>
                            <p class="text-slate-400">You two should get a room... and watch a movie.</p>
                        </div>
                    `;
                }

                if (slide.type === 'streak') {
                    return `
                        <div class="${commonClass}">
                            <div class="text-6xl mb-6">üî•</div>
                            <h2 class="text-xl font-bold text-orange-500 uppercase tracking-widest mb-4">The Streak</h2>
                            <h1 class="text-8xl font-black text-white mb-2">${slide.data}</h1>
                            <p class="text-slate-400">Days in a row. Unstoppable.</p>
                        </div>
                    `;
                }

                if (slide.type === 'critic') {
                    const w = slide.data;
                    return `
                        <div class="${commonClass}">
                            <div class="text-6xl mb-6">‚öñÔ∏è</div>
                            <h2 class="text-xl font-bold text-slate-300 uppercase tracking-widest mb-4">The Critic</h2>
                            <h1 class="text-5xl font-black text-white mb-4">"${w.critic_persona}"</h1>
                            
                            <div class="flex items-end gap-2 h-32 w-full max-w-xs px-4">
                                <div class="w-1/5 bg-red-500 rounded-t-lg relative group" style="height: ${(w.rating_dist['1'] || 0) * 10}%">
                                    <span class="absolute -top-6 left-1/2 -translate-x-1/2 text-xs">1‚òÖ</span>
                                </div>
                                <div class="w-1/5 bg-orange-500 relative" style="height: ${(w.rating_dist['2'] || 0) * 10}%"></div>
                                <div class="w-1/5 bg-yellow-500 relative" style="height: ${(w.rating_dist['3'] || 0) * 10}%"></div>
                                <div class="w-1/5 bg-lime-500 relative" style="height: ${(w.rating_dist['4'] || 0) * 10}%"></div>
                                <div class="w-1/5 bg-green-500 relative" style="height: ${(w.rating_dist['5'] || 0) * 10}%">
                                    <span class="absolute -top-6 left-1/2 -translate-x-1/2 text-xs">5‚òÖ</span>
                                </div>
                            </div>
                        </div>
                    `;
                }



                if (slide.type === 'countries') {
                    // Country Map
                    const countryMap = {
                        "US": "üá∫üá∏ Hollywood", "GB": "üá¨üáß UK", "NG": "üá≥üá¨ Nollywood", "IN": "üáÆüá≥ Bollywood",
                        "KR": "üá∞üá∑ K-Drama", "JP": "üáØüáµ Anime", "FR": "üá´üá∑ France", "Unknown": "üè≥Ô∏è Earth"
                    };

                    const list = s.top_countries.slice(0, 4).map(c => `
            <div onclick="StoryManager.drillDownCountry('${c[0]}')"
        class="bg-white/10 backdrop-blur-md rounded-2xl p-6 flex flex-col items-center cursor-pointer hover:bg-white/20 transition-all hover:scale-105 active:scale-95" >
                             <span class="text-4xl mb-2">${(countryMap[c[0]] || '').split(' ')[0] || 'üè≥Ô∏è'}</span>
                             <span class="font-bold text-xl">${(countryMap[c[0]] || c[0]).split(' ').slice(1).join(' ') || c[0]}</span>
                             <span class="text-xs opacity-70 mt-1">${c[1]} Titles</span>
                        </div >
            `).join('');

                    return `
            <div class="${commonClass} w-full max-w-lg" >
                             <h2 class="text-2xl font-bold text-slate-300 uppercase tracking-widest mb-8">Global Taste</h2>
                             <div class="grid grid-cols-2 gap-4 w-full">
                                 ${list}
                             </div>
                             <p class="mt-6 text-sm text-white/50 animate-pulse">Tap a country to explore</p>
                        </div >
            `;
                }
            }
        };

        function closeAddModal() { document.getElementById('add-modal').classList.add('hidden'); }

        // REMOVED DUPLICATE submitManualAdd() that was broken.


        // Init

        function toggleDateInput() {
            const status = document.getElementById('add-status').value;
            const dateContainer = document.getElementById('add-date-container');
            if (status === 'watched') {
                dateContainer.classList.remove('hidden');
            } else {
                dateContainer.classList.add('hidden');
            }
        }
        // Sync Token to Cookie for Extension
        const cookieToken = localStorage.getItem('access_token');
        if (cookieToken) {
            document.cookie = `access_token = ${cookieToken}; path =/; max-age=86400; SameSite=Lax`;
        }

        switchTab('watchlist'); // Default tab
        // init(); // Moved to end
        // StoryManager.init(); // Moved to end
        // startAutoRefresh(); // Moved to end
        async function loadSprint() {
            const res = await authFetch('/api/stats/sprint');
            if (!res.ok) return;
            const data = await res.json();

            document.getElementById('sprint-hours').innerText = data.total_hours;
            document.getElementById('sprint-count').innerText = data.total_count;
            document.getElementById('sprint-minutes').innerText = data.total_minutes;

            const list = document.getElementById('sprint-list');
            if (data.items.length === 0) {
                list.innerHTML = '<li class="text-slate-500 italic text-sm">No watching in last 14 days.</li>';
                return;
            }

            list.innerHTML = data.items.map(i => `
                <li class="flex items-center gap-3 p-2 hover:bg-white/5 rounded transition-colors group cursor-pointer" onclick="this.classList.toggle('opacity-50'); this.classList.toggle('line-through')">
                    <div class="w-4 h-4 rounded-full border border-blue-500/50 flex items-center justify-center group-hover:bg-blue-500 transition-colors">
                        <div class="w-2 h-2 bg-white rounded-full opacity-0 group-hover:opacity-100"></div>
                    </div>
                    <span class="text-sm text-slate-300 group-hover:text-white truncate flex-1">${i.title}</span>
                    <span class="text-xs text-slate-600">${new Date(i.watched_at).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}</span>
                </li>
            `).join('');
        }
        // --- Inbox Logic ---
        function openInbox() {
            document.getElementById('inbox-modal').classList.remove('hidden');
            loadInbox();
            // Mark all messages as read
            markInboxAsRead();
        }

        async function markInboxAsRead() {
            try {
                await authFetch('/api/inbox/mark-read', { method: 'POST' });
                // Update badge after marking as read
                setTimeout(pollInbox, 500);
            } catch (e) {
                console.error('Failed to mark inbox as read:', e);
            }
        }

        // --- Playlist Add Logic ---
        let currentPlaylistAddItem = null;

        function openCreatePlaylistModal() {
            document.getElementById('create-playlist-modal').classList.remove('hidden');
        }

        async function loadMyPlaylists() {
            const res = await authFetch('/api/playlists');
            if (!res.ok) return;
            const lists = await res.json();

            const container = document.getElementById('playlists-container');
            if (lists.length === 0) {
                container.innerHTML = `
                            <div class="col-span-full text-center py-12 bg-white/5 rounded-2xl border border-dashed border-white/10">
                                <div class="text-4xl mb-4"><i data-lucide="folder-open" class="w-16 h-16 text-slate-600 inline-block"></i></div>
                                <div class="text-slate-400 font-medium mb-2">No Playlists Yet</div>
                                <div class="text-slate-500 text-sm mb-6">Create themed collections like "Weekend Binge" or "Sci-Fi Goats"</div>
                                <button onclick="openCreatePlaylistModal()" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">
                                    Create Your First Playlist
                                </button>
                            </div>
                        `;
                return;
            }

            container.innerHTML = lists.map(p => `
                        <div class="glass rounded-xl p-6 relative group hover:bg-white/10 transition-colors cursor-pointer" onclick="viewPlaylist(${p.id})">
                            <div class="absolute top-4 right-4 text-xs bg-black/40 px-2 py-1 rounded text-slate-400">
                                ${p.item_count} items
                            </div>
                            <h3 class="text-xl font-bold text-white mb-2 truncate pr-16">${p.name}</h3>
                            <p class="text-sm text-slate-400 line-clamp-2 h-10 mb-4">${p.description || 'No description'}</p>
                            
                            <div class="flex items-center gap-2 mt-auto">
                                <span class="text-xs px-2 py-0.5 rounded ${p.is_public ? 'bg-green-500/10 text-green-400' : 'bg-red-500/10 text-red-400'}">
                                    ${p.is_public ? 'Public' : 'Private'}
                                </span>
                                    ${p.is_public ? 'Public' : 'Private'}
                                </span>
                            </div>
                        </div>
                    `).join('');
        }

        async function submitCreatePlaylist() {
            const name = document.getElementById('new-playlist-name').value;
            const desc = document.getElementById('new-playlist-desc').value;
            const isPublic = document.getElementById('new-playlist-public').checked;

            if (!name) return alert("Name is required");

            const res = await authFetch('/api/playlists', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, description: desc, is_public: isPublic })
            });

            if (res.ok) {
                document.getElementById('create-playlist-modal').classList.add('hidden');
                document.getElementById('new-playlist-name').value = '';
                document.getElementById('create-party-time').value = new Date().toISOString().slice(0, 16);
            }
        }

        async function joinParty(id) {
            try {
                const res = await authFetch(`/api/social/parties/${id}/join`, { method: 'POST' });
                if (res.ok) {
                    alert("You have joined the Watch Party! üçø");
                    loadParties(); // Refresh list
                } else {
                    const err = await res.json();
                    alert("Failed to join: " + (err.detail || "Unknown error"));
                }
            } catch (e) {
                console.error(e);
                alert("Error joining party.");
            }
        }

        // --- Leaderboard ---
        async function viewPlaylist(id) {
            const modal = document.getElementById('playlist-details-modal');
            const nameEl = document.getElementById('playlist-detail-name');
            const descEl = document.getElementById('playlist-detail-desc');
            const listEl = document.getElementById('playlist-detail-list');

            // Wire up buttons
            document.getElementById('playlist-share-btn').onclick = () => sharePlaylist(id);
            document.getElementById('playlist-collab-btn').onclick = () => openCollaborateModal(id);
            document.getElementById('playlist-delete-btn').onclick = () => deletePlaylist(id);

            // Show Loading
            modal.classList.remove('hidden');
            nameEl.innerText = "Loading...";
            descEl.innerText = "";
            listEl.innerHTML = '<div class="col-span-full py-20 text-center text-slate-500 animate-pulse">Fetching items...</div>';

            try {
                const res = await authFetch(`/api/playlists/${id}`);
                if (res && res.ok) {
                    const data = await res.json();

                    nameEl.innerText = data.name;
                    descEl.innerText = data.description || "No description provided.";

                    // Toggle delete visibility (only owner)
                    const deleteBtn = document.getElementById('playlist-delete-btn');
                    if (data.is_owner) deleteBtn.classList.remove('hidden');
                    else deleteBtn.classList.add('hidden');

                    if (!data.items || data.items.length === 0) {
                        listEl.innerHTML = '';
                        document.getElementById('playlist-empty-state').classList.remove('hidden');
                    } else {
                        document.getElementById('playlist-empty-state').classList.add('hidden');
                        listEl.innerHTML = data.items.map(item => `
                            <div class="bg-white/5 hover:bg-white/10 p-4 rounded-xl flex gap-4 transition-colors group relative">
                                <div class="w-12 h-16 bg-slate-800 rounded-lg flex-shrink-0 overflow-hidden relative">
                                     ${item.poster_path ?
                                `<img src="https://image.tmdb.org/t/p/w200${item.poster_path}" class="w-full h-full object-cover">` :
                                `<div class="w-full h-full flex items-center justify-center text-xs text-slate-600 font-bold bg-slate-900 border border-slate-700">
                                            ${item.media_type === 'movie' ? '<i data-lucide="film" class="w-3 h-3"></i>' : '<i data-lucide="tv" class="w-3 h-3"></i>'}
                                         </div>`
                            }
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-bold text-white truncate pr-6">${item.title || 'Unknown Title'}</h4>
                                    <div class="flex gap-2 text-[10px] text-slate-400 mt-1 uppercase tracking-wider">
                                        <span>${item.media_type}</span>
                                        <span>‚Ä¢</span>
                                        <span>Added ${new Date(item.added_at).toLocaleDateString()}</span>
                                    </div>
                                </div>
                                <button onclick="removePlaylistItem(${id}, ${item.id})" class="absolute top-2 right-2 text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity bg-black/50 rounded-full p-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                </button>
                            </div>
                        `).join('');
                    }
                }
            } catch (e) {
                console.error(e);
                nameEl.innerText = "Error";
                listEl.innerHTML = '<div class="col-span-full text-red-400 text-center">Failed to load playlist.</div>';
            }
        }

        async function deletePlaylist(id) {
            if (!confirm("Are you sure you want to delete this playlist?")) return;
            try {
                // Assuming we add a DELETE endpoint logic? Or just hide for now.
                // The prompt implies functionality.
                // I need to add DELETE /api/playlists/{id} in backend/main.py or use existing...
                // Wait, I didn't verify if DELETE exists. I'll stick to a placeholder "Deleted" and hide modal.
                // Actually, I should probably implement it if checking.
                // Let's assume frontend logic first.
                // For now, let's call DELETE
                const res = await authFetch(`/api/playlists/${id}`, { method: 'DELETE' });
                if (res && res.ok) {
                    alert("Playlist deleted.");
                    document.getElementById('playlist-details-modal').classList.add('hidden');
                    loadMyPlaylists();
                } else {
                    alert("Failed to delete.");
                }
            } catch (e) { console.error(e); alert("Error deleting."); }
        }

        async function removePlaylistItem(pid, itemId) {
            if (!confirm("Remove this item?")) return;
            try {
                const res = await authFetch(`/api/playlists/${pid}/items/${itemId}`, { method: 'DELETE' });
                if (res.ok) {
                    // unexpected success or standard
                    viewPlaylist(pid); // reload
                } else {
                    alert("Failed to remove item.");
                }
            } catch (e) {
                console.error(e);
                alert("Error removing item.");
            }
        }


        async function sharePlaylist(id) {
            const url = window.location.origin + `/playlist/${id}`;
            // Copy to clipboard
            try {
                await navigator.clipboard.writeText(url);
                alert("Public Link copied to clipboard!");
            } catch (e) {
                alert("Share Link: " + url);
            }
        }

        // --- Messages ---
        async function loadInbox() {
            const res = await authFetch('/api/inbox');
            if (res && res.ok) {
                const msgs = await res.json();
                const container = document.getElementById('inbox-list');
                if (msgs.length === 0) {
                    container.innerHTML = '<div class="text-slate-500 text-center py-10 italic">Your inbox is empty.</div>';
                    return;
                }
                container.innerHTML = msgs.map(m => `
                    <div class="bg-white/5 p-4 rounded-xl border border-white/5">
                        <div class="flex items-center gap-3 mb-2">
                            <img src="${m.sender_pic}" class="w-8 h-8 rounded-full">
                            <div>
                                <div class="text-sm font-bold text-white">${m.sender_name}</div>
                                <div class="text-[10px] text-slate-500">${new Date(m.created_at).toLocaleDateString()}</div>
                            </div>
                        </div>
                        <div class="text-sm text-slate-300 mb-3 ml-11">
                            ${m.type === 'recommendation' ? 'Recommended a title' : (m.type === 'dm' ? 'Sent a message' : 'Sent an invite')}:
                            <div class="italic text-white/80 mt-1 bg-black/20 p-2 rounded">"${m.message || ''}"</div>
                        </div>
                        <div class="flex justify-end gap-2">
                            ${m.type === 'dm'
                        ? `<button onclick="openDMModal(${m.sender_id}, '${m.sender_name}')" class="px-3 py-1.5 text-xs font-bold text-white bg-indigo-600 hover:bg-indigo-500 rounded-lg">Reply</button>`
                        : `<button onclick="processMessage(${m.id}, 'accept')" class="px-3 py-1.5 text-xs font-bold text-white bg-indigo-600 hover:bg-indigo-500 rounded-lg">Add to List</button>`
                    }
                        </div>
                    </div>
                    </div>
                `).join('');
            }
        }

        async function processMessage(id, action) {
            await authFetch(`/api/inbox/${id}/process?action=${action}`, { method: 'POST' });
            loadInbox();
        }

        // --- DM Logic ---
        function openDMModal(userId, userName) {
            document.getElementById('dm-recipient-id').value = userId;
            document.getElementById('dm-recipient-name').innerText = userName;
            document.getElementById('dm-message-content').value = '';
            document.getElementById('dm-modal').classList.remove('hidden');
        }

        async function sendDM() {
            const userId = document.getElementById('dm-recipient-id').value;
            const msg = document.getElementById('dm-message-content').value;
            if (!msg) return alert("Message cannot be empty");

            try {
                const res = await authFetch('/api/inbox/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recipient_id: userId, content: msg })
                });

                if (res.ok) {
                    alert("Message sent!");
                    document.getElementById('dm-modal').classList.add('hidden');
                } else {
                    alert("Failed to send.");
                }
            } catch (e) {
                console.error(e);
                alert("Error sending message.");
            }
        }

        // --- Sending Logic ---
        async function openSendRecModal(tmdbId, userId, userName) {
            // If tmdbId is passed, we are sending a specific item (from details or list)
            if (tmdbId) {
                document.getElementById('send-rec-content-id').value = tmdbId;
            } else {
                if (!tmdbId) {
                    alert("To recommend, click the 'Share' icon on a movie card!");
                    return;
                }
            }

            // Load friends
            const res = await authFetch('/api/social/following');
            if (res.ok) {
                const friends = await res.json();
                const select = document.getElementById('send-rec-user');

                // If userId passed (pre-fill), we might not be following them?
                // Just list following for now.
                let options = friends.map(f => `<option value="${f.id}" ${f.id === userId ? 'selected' : ''}>${f.name}</option>`).join('');

                if (userId && !friends.find(f => f.id === userId)) {
                    // Add temp option if not following
                    options += `<option value="${userId}" selected>${userName} (Not following)</option>`;
                }

                select.innerHTML = options || '<option>No friends available</option>';
            }
            document.getElementById('send-rec-modal').classList.remove('hidden');
        }

        async function submitRecommendation() {
            const receiverId = document.getElementById('send-rec-user').value;
            const contentId = document.getElementById('send-rec-content-id').value;
            const msg = document.getElementById('send-rec-msg').value;

            if (!receiverId) return alert("Select a friend!");

            await authFetch('/api/inbox/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    receiver_id: parseInt(receiverId),
                    content_id: parseInt(contentId),
                    type: 'recommendation',
                    message: msg
                })
            });

            document.getElementById('send-rec-modal').classList.add('hidden');
            alert("Recommendation Sent!");
        }

        // Start App
        document.addEventListener('DOMContentLoaded', () => {
            init();
            StoryManager.init();
            startAutoRefresh();
        });
    </script>

    <!-- DM Modal -->
    <div id="dm-modal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div
            class="bg-[#1e293b] rounded-2xl p-6 max-w-sm w-full mx-4 border border-slate-700 shadow-2xl relative animate-in">
            <button onclick="document.getElementById('dm-modal').classList.add('hidden')"
                class="absolute top-4 right-4 text-slate-400 hover:text-white">‚úï</button>
            <h3 class="text-xl font-bold mb-4 text-white flex items-center gap-2">
                <i data-lucide="message-circle" class="text-indigo-400 w-5 h-5"></i>
                Message <span id="dm-recipient-name" class="text-indigo-300"></span>
            </h3>
            <input type="hidden" id="dm-recipient-id">
            <div class="mb-4">
                <textarea id="dm-message-content"
                    class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-white text-sm focus:outline-none focus:border-indigo-500 transition-colors"
                    rows="4" placeholder="Type your message..."></textarea>
            </div>
            <button onclick="sendDM()"
                class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold transition-colors shadow-lg shadow-indigo-500/20">Send
                Message</button>
        </div>
    </div>
    <!-- PARTY ROOM MODAL -->
    <div id="party-room-modal"
        class="fixed inset-0 bg-black/95 hidden z-[60] flex flex-col items-center justify-center animate-in backdrop-blur-md">
        <button onclick="document.getElementById('party-room-modal').classList.add('hidden')"
            class="absolute top-4 right-4 text-slate-400 hover:text-white z-50">‚úï</button>

        <div
            class="w-full max-w-5xl h-[85vh] bg-[#0f172a] rounded-2xl border border-slate-800 flex overflow-hidden shadow-2xl relative">
            <!-- Left: Video Area (Placeholder) -->
            <div class="w-full md:w-2/3 bg-black flex flex-col items-center justify-center relative group">
                <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-60">
                </div>
                <img src="/static/placeholder_movie.jpg"
                    class="absolute inset-0 w-full h-full object-cover opacity-30 group-hover:opacity-20 transition-opacity">

                <div class="z-10 text-center">
                    <h1 id="party-room-title" class="text-4xl font-black text-white mb-2 drop-shadow-xl tracking-tight">
                    </h1>
                    <div
                        class="inline-flex items-center gap-2 bg-red-600/20 text-red-400 px-3 py-1 rounded-full text-xs font-bold border border-red-600/30 mb-8">
                        <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> LIVE
                    </div>

                    <button
                        class="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-3 rounded-full font-bold shadow-lg shadow-indigo-600/30 hover:scale-105 transition-transform flex items-center gap-2 mx-auto">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                            fill="currentColor">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        Play Sync
                    </button>
                    <div class="text-xs text-slate-400 mt-4 font-mono">Synced via Cine-Sync‚Ñ¢ Protocol</div>
                </div>
            </div>

            <!-- Right: Chat -->
            <div class="hidden md:flex w-1/3 bg-slate-900 border-l border-slate-700 flex-col">
                <div
                    class="p-4 border-b border-slate-800 font-bold text-white flex justify-between items-center bg-slate-900/50">
                    <div class="flex items-center gap-2">
                        <i data-lucide="message-square" class="w-4 h-4 text-indigo-400"></i>
                        <span>Party Chat</span>
                    </div>
                    <span
                        class="text-[10px] bg-green-500/10 text-green-400 px-2 py-0.5 rounded border border-green-500/20">‚óè
                        Online</span>
                </div>

                <div id="party-chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth">
                    <!-- Msgs -->
                </div>

                <div class="p-3 border-t border-slate-800 bg-slate-800/30">
                    <form onsubmit="sendPartyChat(event)" class="flex gap-2">
                        <input type="hidden" id="current-party-id">
                        <input type="text" id="party-chat-input"
                            class="flex-1 bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-indigo-500 placeholder:text-slate-600 transition-colors"
                            placeholder="Say something...">
                        <button type="submit"
                            class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Global Floating Action Button for Adding Entries -->
    <button onclick="openAddModal()"
        class="fixed bottom-8 right-8 z-50 bg-indigo-600 hover:bg-indigo-500 text-white rounded-full p-4 shadow-2xl shadow-indigo-500/50 flex items-center gap-2 group transition-all hover:scale-105 active:scale-95">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        <span
            class="max-w-0 overflow-hidden group-hover:max-w-xs transition-all duration-300 font-bold whitespace-nowrap text-sm">Add
            / Block</span>
    </button>

    <script>
        // Party Chat Logic
        let partyChatInterval;

        function enterParty(id, title) {
            document.getElementById('current-party-id').value = id;
            document.getElementById('party-room-title').innerText = title;
            document.getElementById('party-room-modal').classList.remove('hidden');
            loadPartyChat(id);
            if (partyChatInterval) clearInterval(partyChatInterval);
            partyChatInterval = setInterval(() => loadPartyChat(id), 3000); // Poll every 3s
        }

        async function loadPartyChat(id) {
            try {
                const res = await authFetch(`/api/social/parties/${id}/chat`);
                if (res.ok) {
                    const msgs = await res.json();
                    const container = document.getElementById('party-chat-messages');
                    const isScrolledToBottom = container.scrollHeight - container.scrollTop === container.clientHeight;

                    container.innerHTML = msgs.map(m => `
                        <div class="flex gap-3 items-start group">
                            <img src="${m.pic}" class="w-8 h-8 rounded-full mt-1 border border-white/10 shadow-sm">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-baseline gap-2 mb-0.5">
                                    <span class="text-xs font-bold text-slate-300 group-hover:text-white transition-colors">${m.user}</span>
                                    <span class="text-[10px] text-slate-600">${m.time}</span>
                                </div>
                                <div class="text-sm text-slate-200 bg-slate-800/80 px-3 py-2 rounded-xl rounded-tl-none inline-block border border-slate-700/50 shadow-sm break-words max-w-full">${m.message}</div>
                            </div>
                        </div>
                    `).join('');

                    if (isScrolledToBottom) {
                        container.scrollTop = container.scrollHeight;
                    }
                }
            } catch (e) { console.error(e); }
        }

        async function sendPartyChat(e) {
            e.preventDefault();
            const id = document.getElementById('current-party-id').value;
            const input = document.getElementById('party-chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            input.value = ''; // Optimistic clear
            await authFetch(`/api/social/parties/${id}/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: msg })
            });
            loadPartyChat(id);
            // Force scroll
            const container = document.getElementById('party-chat-messages');
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>

</html>